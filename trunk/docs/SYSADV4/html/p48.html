<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@17046-->
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Features in NFS Version 4 - System Administration Guide: Network Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2007-02-01">
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/ipg.css">
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<!--stopindex-->

<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<?GenHTML ReferencePage >System Administration Guide: Network Services<?GenHTML /ReferencePage> > <a href="p31.html">6.&nbsp;&nbsp;Accessing Network File Systems (Reference)</a> > <a href="p47.html#rfsrefer-45">How the NFS Service Works</a>
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr valign="bottom"><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr><td colspan="5"></td></tr>
<tr>
<td></td>
<td style="width: 60%">&nbsp;</td>
<td><a href="p47.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p49.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<a name="rfsrefer-134"></a><h4>Features in NFS Version 4</h4>
<a name="indexterm-675"></a><p>Many changes have been made to NFS in version 4. This section provides
descriptions of these new features.</p>
<ul><li><p><a href="p48.html#rfsrefer-148">Unsharing and Resharing a File System in NFS Version 4</a></p>
</li>
<li><p><a href="p48.html#rfsrefer-136">File-System Namespace in NFS Version 4</a></p>
</li>
<li><p><a href="p48.html#rfsrefer-137">Volatile File Handles in NFS Version 4</a></p>
</li>
<li><p><a href="p48.html#rfsrefer-138">Client Recovery in NFS Version 4</a></p>
</li>
<li><p><a href="p49.html"><tt>OPEN</tt> Share Support in NFS Version 4</a></p>
</li>
<li><p><a href="p49.html#rfsrefer-140">Delegation in NFS Version 4</a></p>
</li>
<li><p><a href="p49.html#gande">ACLs and <tt>nfsmapid</tt> in NFS Version 4</a></p>
</li>
<li><p><a href="p50.html#rfsrefer-111">Client-Side Failover in NFS Version 4</a></p>
</li>
</ul>
<hr>
<p><b>Note - </b>Starting in the Solaris 10 release, NFS version 4 does not support
the LIPKEY/SPKM security flavor. Also, NFS version 4 does not use the <tt>mountd</tt>, <tt>nfslogd</tt>, and <tt>statd</tt> daemons.</p>
<hr>
<p>For procedural information related to using NFS version 4, refer to <a href="p19.html">Setting Up NFS Services</a>.</p>
<a name="rfsrefer-148"></a><h5>Unsharing and Resharing a File System in NFS
Version 4</h5>
<a name="indexterm-676"></a><p>With both NFS version 3 and version 4, if a client attempts to access
a file system that has been unshared, the server responds with an error code.
However, with NFS version 3 the server maintains any locks that the clients
had obtained before the file system was unshared.  Thus, when the file system
is reshared, NFS version 3 clients can access the file system as though that
file system had never been unshared.</p>
<p>With NFS version 4, when a file system is unshared, all the state for
any open files or file locks in that file system is destroyed. If the client
attempts to access these files or locks, the client receives an error. This
error is usually reported as an <tt>I/O</tt> error to the application.
Note, however, that resharing a currently shared file system to change options
does not destroy any of the state on the server.</p>
<p>For related information, refer to <a href="p48.html#rfsrefer-138">Client Recovery in NFS Version 4</a> or see the <tt>unshare_nfs</tt>(1M) man page.</p>
<a name="rfsrefer-136"></a><h5>File-System Namespace in NFS Version 4</h5>
<a name="indexterm-677"></a><p>NFS version 4 servers create and maintain a pseudo-file system, which
provides clients with seamless access to all exported objects on the server.
Prior to NFS version 4, the pseudo-file system did not exist. Clients were
forced to mount each shared server file system for access. Consider the following
example.</p>
<a name="rfsrefer-fig-131"></a>Figure 6-2 Views of the Server File System and the
Client File System<img src="figures/servr-client-views.gif" alt=""></img><p>Note that the client cannot see the <tt>payroll</tt> directory
and the <tt>nfs4x</tt> directory, because these directories are
not exported and do not lead to exported directories. However, the <tt>local</tt> directory is visible to the client, because <tt>local</tt> is
an exported directory. The <tt>projects</tt> directory is visible
to the client, because <tt>projects</tt> leads to the exported
directory, <tt>nfs4</tt>. Thus, portions of the server namespace
that are not explicitly exported are bridged with a pseudo-file system that
views only the exported directories and those directories that lead to server
exports.</p>
<p>A pseudo-file system is a structure that contains only directories and
is created by the server.  The pseudo-file system permits a client to browse
the hierarchy of exported file systems.  Thus, the client's view of the pseudo-file
system is limited to paths that lead to exported file systems.</p>
<p>Previous versions of NFS did not permit a client to traverse server
file systems without mounting each file system.  However, in NFS version 4,
the server namespace does the following:</p>
<ul><li><p>Restricts the client's file-system view to directories that
lead to server exports.</p>
</li>
<li><p>Provides clients with seamless access to server exports without
requiring that the client mount each underlying file system. See the previous
example. Note, however, that different operating systems might require the
client to mount each server file system.</p>
</li>
</ul>
<p>For POSIX-related reasons, the Solaris NFS version 4 client does not
cross server file-system boundaries. When such attempts are made, the client
makes the directory appear to be empty. To remedy this situation, you must
perform a mount for each of the server's file systems.</p>
<a name="rfsrefer-137"></a><h5>Volatile File Handles in NFS Version 4</h5>
<a name="indexterm-678"></a><p>File handles are created on the server and contain information that
uniquely identifies files and directories. In NFS versions 2 and 3 the server
returned persistent file handles. Thus, the client could guarantee that the
server would generate a file handle that always referred to the same file.
For example:</p>
<ul><li><p>If a file was deleted and replaced with a file of the same
name, the server would generate a new file handle for the new file. If the
client used the old file handle, the server would return an error that the
file handle was stale.</p>
</li>
<li><p>If a file was renamed, the file handle would remain the same.</p>
</li>
<li><p>If you had to reboot the server, the file handles would remain
the same.</p>
</li>
</ul>
<p>Thus, when the server received a request from a client that included
a file handle, the resolution was straightforward and the file handle always
referred to the correct file.</p>
<p>This method of identifying files and directories for NFS operations
was fine for most UNIX-based servers. However, the method could not be implemented
on servers that relied on other methods of identification, such as a file's
path name. To resolve this problem, the NFS version 4 protocol permits a server
to declare that its file handles are volatile. Thus, a file handle could change.
If the file handle does change, the client must find the new file handle.</p>
<p>Like NFS versions 2 and 3, the Solaris NFS version 4 server always provides
persistent file handles. However, Solaris NFS version 4 clients that access
non-Solaris NFS version 4 servers must support volatile file handles if the
server uses them. Specifically, when the server tells the client that the
file handle is volatile, the client must cache the mapping between path name
and file handle. The client uses the volatile file handle until it expires.
On expiration, the client does the following:</p>
<ul><li><p>Flushes the cached information that refers to that file handle</p>
</li>
<li><p>Searches for that file's new file handle</p>
</li>
<li><p>Retries the operation</p>
</li>
</ul>
<hr>
<p><b>Note - </b>The server always tells the client which file handles are persistent
and which file handles are volatile.</p>
<hr>
<p>Volatile file handles might expire for any of these reasons:</p>
<ul><li><p>When you close a file</p>
</li>
<li><p>When the filehandle's file system migrates</p>
</li>
<li><p>When a client renames a file</p>
</li>
<li><p>When the server reboots</p>
</li>
</ul>
<p>Note that if the client is unable to find the new file handle, an error
message is put in the <tt>syslog</tt> file. Further attempts to
access this file fail with an <tt>I/O</tt> error.</p>
<a name="rfsrefer-138"></a><h5>Client Recovery in NFS Version 4</h5>
<a name="indexterm-679"></a><p>The NFS version 4 protocol is a stateful protocol. A protocol is stateful
when both the client and the server maintain current information about the
following.</p>
<ul><li><p>Open files</p>
</li>
<li><p>File locks</p>
</li>
</ul>
<p>When a failure occurs, such as a server crash, the client and the server
work together to reestablish the open and lock states that existed prior to
the failure.</p>
<p>When a server crashes and is rebooted, the server loses its state. The
client detects that the server has rebooted and begins the process of helping
the server rebuild its state. This process is known as client recovery, because
the client directs the process.</p>
<p>When the client discovers that the server has rebooted, the client immediately
suspends its current activity and begins the process of client recovery. 
When the recovery process starts, a message, such as the following, is displayed
in the system error log <tt>/var/adm/messages</tt>.</p>
<pre>NOTICE: Starting recovery server <i>basil.example.company.com</i></pre><p>During the recovery process, the client sends the server information
about the client's previous state.  Note, however, that during this period
the client does not send any new requests to the server.  Any new requests
to open files or set file locks must wait for the server to complete its recovery
period before proceeding.</p>
<p>When the client recovery process is complete, the following message
is displayed in the system error log <tt>/var/adm/messages</tt>.</p>
<pre>NOTICE: Recovery done for server <i>basil.example.company.com</i></pre><p>Now the client has successfully completed sending its state information
to the server.  However, even though the client has completed this process,
other clients might not have completed their process of sending state information
to the server.  Therefore, for a period of time, the server does not accept
any open or lock requests. This period of time, which is known as the grace
period, is designated to permit all the clients to complete their recovery.</p>
<p>During the grace period, if the client attempts to open any new files
or establish any new locks, the server denies the request with the <tt>GRACE</tt> error code. On receiving this error, the client must wait for the
grace period to end and then resend the request to the server.  During the
grace period the following message is displayed.</p>
<pre>NFS server recovering</pre><p>Note that during the grace period the commands that do not open files
or set file locks can proceed.   For example, the commands <tt>ls</tt> and <tt>cd</tt> do not open a file or set a file lock. Thus, these commands are
not  suspended. However, a command such as <tt>cat</tt>, which opens
a file, would be suspended until the grace period ends.</p>
<p>When the grace period has ended, the following message is displayed.</p>
<pre>NFS server recovery ok.</pre><p>The client can now send new open and lock requests to  the server.</p>
<p>Client recovery can fail for a variety of reasons. For example, if a
network partition exists after the server reboots, the client might not be
able to reestablish its state with the server before the grace period ends.
 When the grace period has ended, the server does not permit the client to
reestablish its state because new state operations could create conflicts.
 For example, a new file lock might conflict with an old file lock that the
client is trying to recover.  When such situations occur, the server returns
the <tt>NO_GRACE</tt> error code to the client.</p>
<p>If the recovery of an open operation for a particular file fails, the
client marks the file as unusable and the following message is displayed.</p>
<pre>WARNING: The following NFS file could not be recovered and was marked dead 
(can't reopen:  NFS status 70):  file :  <i>filename</i></pre><p>Note that the number <tt>70</tt> is only an example.</p>
<p>If reestablishing a file lock during recovery fails, the following error
message is posted.</p>
<pre>NOTICE: nfs4_send_siglost:  pid <i>PROCESS-ID</i> lost
lock on server <i>SERVER-NAME</i></pre><p>In this situation, the <tt>SIGLOST</tt> signal is posted to
the process. The default action for the <tt>SIGLOST</tt> signal
is to terminate the process.</p>
<p>For you to recover from this state, you must restart any applications
that had files open at the time of  the failure. Note that the following can
occur.</p>
<ul><li><p>Some processes that did not reopen the file could receive <tt>I/O</tt> errors.</p>
</li>
<li><p>Other processes that did reopen the file, or performed the
open operation after the recovery failure, are able to access the file without
any problems.</p>
</li>
</ul>
<p>Thus, some processes can access a particular file while other processes
cannot.</p>

</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr valign="bottom">
<td></td>
<td style="width: 60%"></td>
<td><a href="p47.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p49.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

