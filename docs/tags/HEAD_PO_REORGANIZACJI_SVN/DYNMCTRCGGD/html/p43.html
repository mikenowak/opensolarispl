<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@17046-->
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title><tt>sdt</tt> Provider - Solaris Dynamic Tracing Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2005-09-01">
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/ipg.css">
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<!--stopindex-->

<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<?GenHTML ReferencePage >Solaris Dynamic Tracing Guide<?GenHTML /ReferencePage>
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr valign="bottom"><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr><td colspan="5"></td></tr>
<tr>
<td></td>
<td style="width: 60%">&nbsp;</td>
<td><a href="p42.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p44.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<a name="chp-sdt"></a>Chapter&nbsp;22<h3><tt>sdt</tt> Provider</h3><p>The Statically Defined Tracing (SDT) provider creates probes at sites that a software programmer has formally designated. The SDT mechanism allows programmers to consciously choose locations of interest to users of DTrace and to convey some semantic knowledge about each location through the probe name. The Solaris kernel has defined a handful of SDT probes, and will likely add more over time. DTrace also provides a mechanism for user application developers to define static probes, described in <a href="p59.html">Chapter&nbsp;34, Statically Defined Tracing for User Applications</a>.</p>
<a name="chp-sdt-1"></a><h3>Probes</h3>
<p><a name="indexterm-355"></a><a name="indexterm-356"></a>The SDT probes defined by the Solaris kernel are listed in <a href="p43.html#tbl-sdt">Table 22-1</a>. The name stability and data stability of these probes are both Private because their description here thus reflects the kernel's implementation and should not be inferred to be an interface commitment. For more information about the DTrace stability mechanism, see <a href="p43.html#chp-sdt-stability">Stability</a>.</p>
<a name="tbl-sdt"></a>Table 22-1 SDT Probes<table><tr><th valign="top"><p>Probe name</p>
</th><th valign="top"><p>Description</p>
</th><th valign="top"><p><tt>arg0</tt></p>
</th></tr>
<tr><td><p><tt>callout-start</tt></p>
</td><td><p>Probe that fires immediately before executing a callout (see <tt>&lt;sys/callo.h></tt>). Callouts are executed by periodic system clock, and represent the implementation for <tt>timeout</tt>(9F).</p>
</td><td><p>Pointer to the <tt>callout_t</tt> (see <tt>&lt;sys/callo.h></tt>) corresponding to the callout to be executed.</p>
</td></tr>
<tr><td><p><tt>callout-end</tt></p>
</td><td><p>Probe that fires immediately after executing a callout (see <tt>&lt;sys/callo.h></tt>).</p>
</td><td><p>Pointer to the <tt>callout_t</tt> (see <tt>&lt;sys/callo.h></tt>) corresponding to the callout just executed.</p>
</td></tr>
<tr><td><p><tt>interrupt-start</tt></p>
</td><td><p>Probe that fires immediately before calling into a device's interrupt handler.</p>
</td><td><p>Pointer to the <tt>dev_info</tt> structure (see <tt>&lt;sys/ddi_impldefs.h></tt>) corresponding to the interrupting device.</p>
</td></tr>
<tr><td><p><tt>interrupt-complete</tt></p>
</td><td><p>Probe that fires immediately after returning from a device's interrupt handler.</p>
</td><td><p>Pointer to <tt>dev_info</tt> structure (see <tt>&lt;sys/ddi_impldefs.h></tt>) corresponding to the interrupting device.</p>
</td></tr>
</table><a name="chp-sdt-2"></a><h3>Examples</h3>
<p><a name="indexterm-357"></a><a name="indexterm-358"></a>The following example is a script to observe callout behavior on a per-second basis:</p>
<pre>#pragma D option quiet

sdt:::callout-start
{
	@callouts[((callout_t *)arg0)->c_func] = count();
}

tick-1sec
{
	printa("%40a %10@d\n", @callouts);
	clear(@callouts);
}</pre><p>Running this example reveals the frequent users of <tt>timeout</tt>(9F) in the system, as shown in the following output:</p>
<pre><tt><b># dtrace -s ./callout.d</b></tt>
                                    FUNC      COUNT
                            TS`ts_update          1
              uhci`uhci_cmd_timeout_hdlr          3
                          genunix`setrun          5
                     genunix`schedpaging          5
                         ata`ghd_timeout         10
 uhci`uhci_handle_root_hub_status_change        309

                                    FUNC      COUNT
              ip`tcp_time_wait_collector          1
                            TS`ts_update          1
              uhci`uhci_cmd_timeout_hdlr          3
                     genunix`schedpaging          4
                          genunix`setrun          8
                         ata`ghd_timeout         10
 uhci`uhci_handle_root_hub_status_change        300

                                    FUNC      COUNT
              ip`tcp_time_wait_collector          0
                        iprb`mii_portmon          1
                            TS`ts_update          1
              uhci`uhci_cmd_timeout_hdlr          3
                     genunix`schedpaging          4
                          genunix`setrun          7
                         ata`ghd_timeout         10
 uhci`uhci_handle_root_hub_status_change        300</pre><p>The <tt>timeout</tt>(9F) interface only produces a single timer expiration. Consumers of <tt>timeout()</tt> requiring interval timer functionality typically reinstall their timeout from their <tt>timeout()</tt> handler. The following example shows this behavior:</p>
<pre>#pragma D option quiet

sdt:::callout-start
{
	self->callout = ((callout_t *)arg0)->c_func;
}

fbt::timeout:entry
/self->callout &amp;&amp; arg2 &lt;= 100/
{
	/*
	 * In this case, we are most interested in interval timeout(9F)s that
	 * are short.  We therefore do a linear quantization from 0 ticks to
	 * 100 ticks.  The system clock's frequency &mdash; set by the variable
	 * "hz" &mdash; defaults to 100, so 100 system clock ticks is one second. 
	 */
	@callout[self->callout] = lquantize(arg2, 0, 100);
}

sdt:::callout-end
{
	self->callout = NULL;
}

END
{
	printa("%a\n%@d\n\n", @callout);
}</pre><p>Running this script and waiting several seconds before typing Control-C results in output similar to the following example:</p>
<pre><tt><b># dtrace -s ./interval.d</b></tt>
<tt><b>^C</b></tt>
genunix`schedpaging

           value  ------------- Distribution ------------- count    
              24 |                                         0        
              25 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 20       
              26 |                                         0        


ata`ghd_timeout

           value  ------------- Distribution ------------- count    
               9 |                                         0        
              10 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 51       
              11 |                                         0        


uhci`uhci_handle_root_hub_status_change

           value  ------------- Distribution ------------- count    
               0 |                                         0        
               1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 1515     
               2 |                                         0</pre><p>The output shows that <tt>uhci_handle_root_hub_status_change()</tt> in the <tt>uhci</tt>(7D) driver represents the shortest interval timer on the system: it is called every system clock tick.</p>
<p>The <tt>interrupt-start</tt> probe can be used to understand interrupt activity. The following example shows how to quantize the time spent executing an interrupt handler by driver name:</p>
<pre>interrupt-start
{
	self->ts = vtimestamp;
}

interrupt-complete
/self->ts/
{
	this->devi = (struct dev_info *)arg0;
	@[stringof(`devnamesp[this->devi->devi_major].dn_name),
	    this->devi->devi_instance] = quantize(vtimestamp - self->ts);
}</pre><p>Running this script results in output similar to the following example:</p>
<pre><tt><b># dtrace -s ./intr.d</b></tt>
dtrace: script './intr.d' matched 2 probes
<tt><b>^C</b></tt>
 isp                                                       0
           value  ------------- Distribution ------------- count    
            8192 |                                         0        
           16384 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 1        
           32768 |                                         0        

  pcf8584                                                   0
           value  ------------- Distribution ------------- count    
              64 |                                         0        
             128 |                                         2        
             256 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         157      
             512 |@@@@@@                                   31       
            1024 |                                         3        
            2048 |                                         0        

  pcf8584                                                   1
           value  ------------- Distribution ------------- count    
            2048 |                                         0        
            4096 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@          154      
            8192 |@@@@@@@                                  37       
           16384 |                                         2        
           32768 |                                         0        

  qlc                                                       0
           value  ------------- Distribution ------------- count    
           16384 |                                         0        
           32768 |@@                                       9        
           65536 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      126      
          131072 |@                                        5        
          262144 |                                         2        
          524288 |                                         0        

  hme                                                       0
           value  ------------- Distribution ------------- count    
            1024 |                                         0        
            2048 |                                         6        
            4096 |                                         2        
            8192 |@@@@                                     89       
           16384 |@@@@@@@@@@@@@                            262      
           32768 |@                                        37       
           65536 |@@@@@@@                                  139      
          131072 |@@@@@@@@                                 161      
          262144 |@@@                                      73       
          524288 |                                         4        
         1048576 |                                         0        
         2097152 |                                         1        
         4194304 |                                         0        

  ohci                                                      0
           value  ------------- Distribution ------------- count    
            8192 |                                         0        
           16384 |                                         3        
           32768 |                                         1        
           65536 |@@@                                      143      
          131072 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     1368     
          262144 |                                         0 </pre><a name="chp-sdt-3"></a><h3>Creating SDT Probes</h3>
<p><a name="indexterm-359"></a><a name="indexterm-360"></a>If you are a device driver developer, you might be interested in creating your own SDT probes in your Solaris driver. The disabled probe effect of SDT is essentially the cost of several no-operation machine instructions. You are therefore encouraged to add SDT probes to your device drivers as needed. Unless these probes negatively affect performance, you can leave them in your shipping code.</p>
<a name="chp-sdt-4"></a><h4>Declaring Probes</h4>
<p>SDT probes are declared using the <tt>DTRACE_PROBE</tt>, <tt>DTRACE_PROBE1</tt>, <tt>DTRACE_PROBE2</tt>, <tt>DTRACE_PROBE3</tt> and <tt>DTRACE_PROBE4</tt> macros from <tt>&lt;sys/sdt.h></tt>. The module name and function name of an SDT-based probe corresponds to the kernel module and function of the probe. The name of the probe depends on the name given in the <tt>DTRACE_PROBE</tt><i>n</i><tt></tt> macro. If the name contains no two consecutive underbars (<tt>__</tt>), the name of the probe is as written in the macro. If the name contains any two consecutive underbars, the probe name converts the consecutive underbars to a single dash (<tt>-</tt>). For example, if a <tt>DTRACE_PROBE</tt> macro specifies <tt>transaction__start</tt>, the SDT probe will be named <tt>transaction-start</tt>. This substitution allows C code to provide macro names that are not valid C identifiers without specifying a string.</p>
<p>DTrace includes the kernel module name and function name as part of the tuple identifying a probe, so you do not need to include this information in the probe name to prevent name space collisions. You can use the command <tt>dtrace -l -P sdt -m <i>module</i></tt> on your driver <i>module</i> to list the probes you have installed and the full names that will be seen by users of DTrace.</p>
<a name="chp-sdt-5"></a><h4>Probe Arguments</h4>
<p><a name="indexterm-361"></a><a name="indexterm-362"></a>The arguments for each SDT probe are the arguments specified in the corresponding <tt>DTRACE_PROBE</tt><i>n</i><tt></tt> macro reference. The number of arguments depends on which macro was used to create the probe: <tt>DTRACE_PROBE1</tt> specifies one argument, <tt>DTRACE_PROBE2</tt> specifies two arguments, and so on. When declaring your SDT probes, you can minimize their disabled probe effect by not dereferencing pointers and not loading from global variables in the probe arguments. Both pointer dereferencing and global variable loading may be done safely in D actions that enable probes, so DTrace users can request these actions only when they are needed.</p>
<a name="chp-sdt-stability"></a><h3>Stability</h3>
<p><a name="indexterm-363"></a><a name="indexterm-364"></a>The SDT provider uses DTrace's stability mechanism to describe its stabilities, as shown in the following table. For more information about the stability mechanism, see <a href="p64.html">Chapter&nbsp;39, Stability</a>.</p>
<table><tr><th><p>Element</p>
</th><th><p>Name stability</p>
</th><th><p>Data stability</p>
</th><th><p>Dependency class</p>
</th></tr>
<tr><td><p>Provider</p>
</td><td><p>Evolving</p>
</td><td><p>Evolving</p>
</td><td><p>ISA</p>
</td></tr>
<tr><td><p>Module</p>
</td><td><p>Private</p>
</td><td><p>Private</p>
</td><td><p>Unknown</p>
</td></tr>
<tr><td><p>Function</p>
</td><td><p>Private</p>
</td><td><p>Private</p>
</td><td><p>Unknown</p>
</td></tr>
<tr><td><p>Name</p>
</td><td><p>Private</p>
</td><td><p>Private</p>
</td><td><p>ISA</p>
</td></tr>
<tr><td><p>Arguments</p>
</td><td><p>Private</p>
</td><td><p>Private</p>
</td><td><p>ISA</p>
</td></tr>
</table>
</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr valign="bottom">
<td></td>
<td style="width: 60%"></td>
<td><a href="p42.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p44.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

