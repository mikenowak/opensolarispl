<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@17046-->
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>File Transfer Size Negotiation - System Administration Guide: Network Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2007-02-01">
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/ipg.css">
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<!--stopindex-->

<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<?GenHTML ReferencePage >System Administration Guide: Network Services<?GenHTML /ReferencePage> > <a href="p31.html">6.&nbsp;&nbsp;Accessing Network File Systems (Reference)</a> > <a href="p47.html#rfsrefer-45">How the NFS Service Works</a>
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr valign="bottom"><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr><td colspan="5"></td></tr>
<tr>
<td></td>
<td style="width: 60%">&nbsp;</td>
<td><a href="p49.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p51.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<a name="rfsrefer-48"></a><h4>File Transfer Size Negotiation</h4>
<a name="indexterm-695"></a><a name="indexterm-696"></a><p>The file transfer size establishes the size of the buffers that are
used when transferring data between the client and the server. In general,
larger transfer sizes are better. The NFS version 3 protocol has an unlimited
transfer size. However, starting with the Solaris 2.6 release, the software
bids a default buffer size of 32 Kbytes. The client can bid a smaller transfer
size at mount time if needed, but under most conditions this bid is not necessary.</p>
<p>The transfer size is not negotiated with systems that use the NFS version
2 protocol. Under this condition, the maximum transfer size is set to 8 Kbytes.</p>
<p>You can use the <tt>-rsize</tt> and <tt>-wsize</tt> options
to set the transfer size manually with the <tt>mount</tt> command.
You might need to reduce the transfer size for some PC clients. Also, you
can increase the transfer size if the NFS server is configured to use larger
transfer sizes.</p>
<hr>
<p><b>Note - </b>Starting in the Solaris 10 release, restrictions on wire transfer
sizes have been relaxed.  The transfer size is based on the capabilities of
the underlying transport.  For example, the NFS transfer limit for UDP is
still 32 Kbytes.  However, because TCP is a streaming protocol without the
datagram limits of UDP, maximum transfer sizes over TCP have been increased
to 1 Mbyte.</p>
<hr>
<a name="rfsrefer-49"></a><h4>How File Systems Are Mounted</h4>
<a name="indexterm-697"></a><a name="indexterm-698"></a><a name="indexterm-699"></a><a name="indexterm-700"></a><p>The following description applies to NFS version 3 mounts. The NFS version
4 mount process does not include the portmap service nor does it include the <tt>MOUNT</tt> protocol.</p>
<p>When a client needs to mount a file system from a server, the client
must obtain a file handle from the server. The file handle must correspond
to the file system. This process requires that several transactions occur
between the client and the server. In this example, the client is attempting
to mount <tt>/home/terry</tt> from the server. A <tt>snoop</tt> trace
for this transaction follows.</p>
<pre>client -> server PORTMAP C GETPORT prog=100005 (MOUNT) vers=3 proto=UDP
server -> client PORTMAP R GETPORT port=33492
client -> server MOUNT3 C Null
server -> client MOUNT3 R Null 
client -> server MOUNT3 C Mount /export/home9/terry
server -> client MOUNT3 R Mount OK FH=9000 Auth=unix
client -> server PORTMAP C GETPORT prog=100003 (NFS) vers=3 proto=TCP
server -> client PORTMAP R GETPORT port=2049
client -> server NFS C NULL3
server -> client NFS R NULL3 
client -> server NFS C FSINFO3 FH=9000
server -> client NFS R FSINFO3 OK
client -> server NFS C GETATTR3 FH=9000
server -> client NFS R GETATTR3 OK</pre><p>In this trace, the client first requests the mount port number from
the portmap service on the NFS server. After the client receives the mount
port number (<tt>33492</tt>), that number is used to test the availability
of the service on the server. After the client has determined that a service
is running on that port number, the client then makes a mount request. When
the server responds to this request, the server includes the file handle for
the file system (<tt>9000</tt>) being mounted. The client then sends
a request for the NFS port number. When the client receives the number from
the server, the client tests the availability of the NFS service (<tt>nfsd</tt>).
Also, the client requests NFS information about the file system that uses
the file handle.</p>
<p><a name="indexterm-701"></a><a name="indexterm-702"></a>In the following trace, the client is mounting the file system
with the <tt>public</tt> option.</p>
<pre>client -> server NFS C LOOKUP3 FH=0000 /export/home9/terry
server -> client NFS R LOOKUP3 OK FH=9000
client -> server NFS C FSINFO3 FH=9000
server -> client NFS R FSINFO3 OK
client -> server NFS C GETATTR3 FH=9000
server -> client NFS R GETATTR3 OK</pre><p>By using the default public file handle (which is <tt>0000</tt>),
all the transactions to obtain information from the portmap service and to
determine the NFS port number are skipped.</p>
<hr>
<p><b>Note - </b>NFS version 4 provides support for volatile file handles. For
more information, refer to <a href="p48.html#rfsrefer-137">Volatile File Handles in NFS Version 4</a>.</p>
<hr>
<a name="rfsrefer-50"></a><h4>Effects of the <tt>-public</tt> Option
and NFS URLs When Mounting</h4>
<p>Using the <tt>-public</tt> option can create conditions that
cause a mount to fail. Adding an NFS URL can also confuse the situation. The
following list describes the specifics of how a file system is mounted when
you use these options.</p>
<ul><li><p><b>Public option with NFS URL</b> &ndash;
Forces the use of the public file handle. The mount fails if the public file
handle is not supported.</p>
</li>
<li><p><b>Public option with regular path</b> &ndash;
Forces the use of the public file handle. The mount fails if the public file
handle is not supported.</p>
</li>
<li><p><b>NFS URL only</b> &ndash; Use
the public file handle if this file handle is enabled on the NFS server. If
the mount fails when using the public file handle, then try the mount with
the <tt>MOUNT</tt> protocol.</p>
</li>
<li><p><b>Regular path only</b> &ndash;
Do not use the public file handle. The <tt>MOUNT</tt> protocol is
used.</p>
</li>
</ul>
<a name="rfsrefer-51"></a><h4>Client-Side Failover</h4>
<a name="indexterm-703"></a><p>By using client-side failover, an NFS client can be aware of multiple
servers that are making the same data available and can switch to an alternate
server when the current server is unavailable. The file system can become
unavailable if one of the following occurs. </p>
<ul><li><p>If the file system is connected to a server that crashes</p>
</li>
<li><p>If the server is overloaded</p>
</li>
<li><p>If a network fault occurs</p>
</li>
</ul>
<p>The failover, under these conditions, is normally transparent to the
user. Thus, the failover can occur at any time without disrupting the processes
that are running on the client.</p>
<p>Failover requires that the file system be mounted read-only. The file
systems must be identical for the failover to occur successfully. See <a href="p50.html#rfsrefer-53">What Is a Replicated File System?</a> for a description
of what makes a file system identical. A static file system or a file system
that is not changed often is the best candidate for failover. </p>
<p>You cannot use CacheFS and client-side failover on the same NFS mount.
Extra information is stored for each CacheFS file system. This information
cannot be updated during failover, so only one of these two features can be
used when mounting a file system.</p>
<p>The number of replicas that need to be established for every file system
depends on many factors. Ideally, you should have a minimum of two servers.
Each server should support multiple subnets. This setup is better than having
a unique server on each subnet. The process requires that each listed server
be checked.  Therefore, if more servers are listed, each mount is slower.</p>
<a name="rfsrefer-52"></a><h5>Failover Terminology</h5>
<a name="indexterm-704"></a><p>To fully comprehend the process, you need to understand two terms.</p>
<ul><li><p><b>failover</b> &ndash; The process of selecting
a server from a list of servers that support a replicated file system. Normally,
the next server in the sorted list is used, unless it fails to respond.</p>
</li>
<li><p><b>remap</b> &ndash; To use a new server. Through
normal use, the clients store the path name for each active file on the remote
file system. During the remap, these path names are evaluated to locate the
files on the new server.</p>
</li>
</ul>
<a name="rfsrefer-53"></a><h5>What Is a Replicated File System?</h5>
<a name="indexterm-705"></a><a name="indexterm-706"></a><p>For the purposes of failover, a file system can be called a <b>replica</b> when each file is the same size and has the same file size or
file type as the original file system. Permissions, creation dates, and other
file attributes are not considered. If the file size or file types are different,
the remap fails and the process hangs until the old server becomes available.
In NFS version 4, the behavior is different. See <a href="p50.html#rfsrefer-111">Client-Side Failover in NFS Version 4</a>.</p>
<p>You can maintain a replicated file system by using <tt>rdist</tt>, <tt>cpio</tt>, or another file transfer mechanism. Because updating the replicated
file systems causes inconsistency, for best results consider these precautions:</p>
<ul><li><p>Renaming the old version of the file before installing a new
version of the file</p>
</li>
<li><p>Running the updates at night when client usage is low</p>
</li>
<li><p>Keeping the updates small</p>
</li>
<li><p>Minimizing the number of copies</p>
</li>
</ul>
<a name="rfsrefer-54"></a><h5>Failover and NFS Locking</h5>
<a name="indexterm-707"></a><a name="indexterm-708"></a><p>Some software packages require read locks on files. To prevent these
products from breaking, read locks on read-only file systems are allowed but
are visible to the client side only. The locks persist through a remap because
the server does not &ldquo;know&rdquo; about the locks. Because the files
should not change, you do not need to lock the file on the server side.</p>
<a name="rfsrefer-111"></a><h5>Client-Side Failover in NFS Version 4</h5>
<a name="indexterm-709"></a><p>In NFS version 4, if a replica cannot be established because the file
sizes are different or the file types are not the same, then the following
happens.</p>
<ul><li><p>The file is marked dead.</p>
</li>
<li><p>A warning is printed.</p>
</li>
<li><p>The application receives a system call failure.</p>
</li>
</ul>
<hr>
<p><b>Note - </b>If you restart the application and try again to access the file,
you should be successful.</p>
<hr>
<p>In NFS version 4, you no longer receive replication errors for directories
of different sizes. In prior versions of NFS,  this condition was treated
as an error and would impede the remapping process.</p>
<p>Furthermore, in NFS version 4, if a directory read operation is unsuccessful,
the operation is performed by the next listed server. In previous versions
of NFS, unsuccessful read operations would cause the remap to fail and the
process to hang until the original server was available.</p>

</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr valign="bottom">
<td></td>
<td style="width: 60%"></td>
<td><a href="p49.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p51.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

