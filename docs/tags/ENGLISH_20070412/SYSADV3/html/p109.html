<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@16097-->
<head>
<META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=iso-8859-1">
<title>System Administration Guide: IP Services</title>
<link rel="stylesheet" type="text/css" href="css/default.css">
<!--stopindex-->
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<A href="toc.html">System Administration Guide: IP Services</A> <font color="red">&gt;&gt;</font> <nobr><A HREF="p107.html#ipsec-mgtasks-1">20.&nbsp;&nbsp;Configuring IPsec (Tasks)</A></nobr> <font color="red">&gt;&gt;</font> <nobr><A HREF="p107.html#ipsec-mgtasks-4">Protecting Traffic With IPsec</A></nobr>&nbsp;
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr class="grey1"><td></td><td align="right"><A HREF="p108.html"><IMG BORDER="0" ALT="Previous" SRC="graphics/prev.gif"> Previous</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="toc.html">Contents</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="idx.html">Index</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="p110.html">Next <IMG BORDER="0" ALT="Next" SRC="graphics/next.gif"></A></td></tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<A NAME="ipsec-mgtasks-13"></A><h3><IMG border="0" alt="Procedure" src="graphics/procedure.gif">How to Manually Create IPsec Security Associations</h3>
<A NAME="indexterm-1791"></A><A NAME="indexterm-1792"></A><A NAME="indexterm-1793"></A><A NAME="indexterm-1794"></A><A NAME="indexterm-1795"></A><A NAME="indexterm-1796"></A><A NAME="indexterm-1797"></A><p><hr size="1" noshade><p><b>Note - </b>You manually manage keying material for a non-global zone from
the global zone.</p>
<hr size="1" noshade></p><p>The following procedure provides the keying material for the procedure, <A HREF="p107.html#ipsec-mgtasks-3">How to Secure Traffic Between Two Systems With IPsec</A>.</p>
<ol><A NAME="ipsec-mgtasks-keymat-1"></A><li><p><b>Generate the keying material for the
SAs. </b></p><p>You need three hexadecimal random numbers for outbound traffic
and three hexadecimal random numbers for inbound traffic.</p>
<p>Therefore, one system needs to generate the following numbers:</p><ul><li><p>Two hexadecimal random numbers as the value for the <tt>spi</tt> keyword.
One number is for outbound traffic. One number is for inbound traffic. Each
number can be up to eight characters long.</p>
</li>
<li><p>Two hexadecimal random numbers for the MD5 algorithm for AH.
Each number must be 32 characters long. One number is for  <tt>dst enigma</tt>.
One number is for <tt>dst partym</tt>.</p>
</li>
<li><p>Two hexadecimal random numbers for the 3DES algorithm for
ESP. For a 192-bit key, each number must be 48 characters long. One number
is for  <tt>dst enigma</tt>. One number is for <tt>dst partym</tt>.</p>
</li>
</ul>
<p>If you have a random number generator at your site, use the generator.
You can also use the <tt>od</tt> command. See <A HREF="p108.html#ipsec-mgtasks-12">How to Generate Random Numbers on a Solaris System</A> for
the procedure.</p>
</li>
<A NAME="ipsec-mgtasks-createsa-1"></A><li><p><b>On the system console on one of
the systems, assume the Primary Administrator role or become superuser.</b></p><p>The Primary Administrator role includes the Primary Administrator profile.
To create the role and assign the role to a user, see Chapter 2, "Working With the Solaris Management Console (Tasks)," in <i>System Administration Guide: Basic Administration</i>.</p>
<p><hr size="1" noshade><p><b>Note - </b>Logging in remotely exposes security-critical traffic to eavesdropping.
Even if you somehow protect the remote login, the security of the system is
reduced to the security of the remote login session.</p>
<hr size="1" noshade></p></li>
<li><p><b>Enable the <tt>ipseckey</tt> command mode:</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre># <tt><b>ipseckey</b></tt>

></pre>
</td></table><br><p><A NAME="indexterm-1798"></A><A NAME="indexterm-1799"></A><A NAME="indexterm-1800"></A><A NAME="indexterm-1801"></A>The > prompt indicates that you are in <tt>ipseckey</tt> command mode.</p>
</li>
<li><p><b><A NAME="indexterm-1802"></A><A NAME="indexterm-1803"></A>If you are replacing existing SAs, flush the current SAs.</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre>> <tt><b>flush</b></tt>
> </pre>
</td></table><br><p><A NAME="indexterm-1804"></A><A NAME="indexterm-1805"></A><A NAME="indexterm-1806"></A><A NAME="indexterm-1807"></A>To prevent an adversary from having time to break your SAs, you
need to replace the keying material.</p>
<p><hr size="1" noshade><p><b>Note - </b>You must coordinate key replacement on communicating systems.
When you replace the SAs on one system, the SAs must also be replaced on the
remote system.</p>
<hr size="1" noshade></p></li>
<li><p><b>To create SAs, type the following command.</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre>> <tt><b>add </tt><i>protocol<tt></i> spi </tt><i>random-hex-string<tt></i> \</b></tt>
<tt><b>src </tt><i>addr<tt></i> dst </tt><i>addr2<tt></i> \</b></tt>
<tt><b></tt><i>protocol-prefix<tt></i>_alg </tt><i>protocol-algorithm<tt></i>  \</b></tt>
<tt><b></tt><i>protocol-prefix<tt></i>key </tt><i>random-hex-string-of-algorithm-specified-length<tt></i></b></tt></pre>
</td></table><br><p>You also use this syntax to replace SAs that you have just flushed.</p>
<dl><dt><i>protocol</i></dt><dd><p>Specifies either <tt>esp</tt> or <tt>ah</tt>.</p>
</dd><dt><i>random-hex-string</i></dt><dd><p>Specifies a random number of up to eight characters in hexadecimal
format. Precede the characters with <tt>0x</tt>. If you enter more
numbers than the security parameter index (SPI) accepts, the system ignores
the extra numbers. If you enter fewer numbers than the SPI accepts, the system
pads your entry.</p>
</dd><dt><i>addr</i></dt><dd><p>Specifies the IP address of one system.</p>
</dd><dt><i>addr2</i></dt><dd><p>Specifies the IP address of the peer system of <i>addr</i>.</p>
</dd><dt><i>protocol-prefix</i></dt><dd><p>Specifies one of <tt>encr</tt> or <tt>auth</tt>.
The <tt>encr</tt> prefix is used with the <tt>esp</tt> protocol.
The <tt>auth</tt> prefix is used with the <tt>ah</tt> protocol,
and for authenticating the <tt>esp</tt> protocol.</p>
</dd><dt><i>protocol-algorithm</i></dt><dd><p>Specifies an algorithm for ESP or AH. Each algorithm requires
a key of a specific length.</p>
<p>Authentication algorithms include MD5 and SHA. Encryption algorithms
include 3DES and AES.</p>
</dd><dt><i>random-hex-string-of-algorithm-specified-length</i></dt><dd><p><A NAME="indexterm-1808"></A><A NAME="indexterm-1809"></A>Specifies a random hexadecimal number of the length that is required
by the algorithm. For example, the MD5 algorithm requires a 32-character string
for its 128-bit key. The 3DES algorithm requires a 48-character string for
its 192-bit key.</p>
</dd></dl>
<ol Type="a"><li><p><b>For example, on the <tt>enigma</tt> system, protect
outbound packets.</b></p><p>Use the random numbers that you generated in <A HREF="p109.html#ipsec-mgtasks-keymat-1">Step&nbsp;1</A>.</p>
<p>For Solaris 10 1/06:</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>> <tt><b>add esp spi 0x8bcd1407 \</b></tt>
<tt><b>src 192.168.116.16 dst 192.168.13.213 \</b></tt>
<tt><b>encr_alg 3des \</b></tt>
<tt><b>auth_alg md5 \</b></tt>
<tt><b>encrkey d41fb74470271826a8e7a80d343cc5aae9e2a7f05f13730d</b></tt> \
<tt><b>authkey e896f8df7f78d6cab36c94ccf293f031</b></tt>
></pre>
</td></table><br><p><hr size="1" noshade><p><b>Note - </b>The peer system must use the same keying material and the same
SPI.</p>
<hr size="1" noshade></p></li>
<li><p><b>Still in <tt>ipseckey</tt> command mode on the <tt>enigma</tt> system,
protect inbound packets.</b></p><p>Type the following commands to protect
the packets:</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>> <tt><b>add esp spi 0x122a43e4 \</b></tt>
<tt><b>src 192.168.13.213 dst 192.168.116.16 \</b></tt>
<tt><b>encr_alg 3des \</b></tt>
<tt><b>auth_alg md5 \</b></tt>
<tt><b>encrkey dd325c5c137fb4739a55c9b3a1747baa06359826a5e4358e</b></tt> \
<tt><b>authkey ad9ced7ad5f255c9a8605fba5eb4d2fd</b></tt>
></pre>
</td></table><br><p><hr size="1" noshade><p><b>Note - </b>The keys and SPI can be different for each SA. You <b>should</b> assign
different keys and a different SPI for each SA.</p>
<hr size="1" noshade></p></li>
</ol>
</li>
<li><p><b>To exit <tt>ipseckey</tt> command mode, press Control-D or type <tt>quit</tt>.</b></p></li>
<A NAME="ipsec-mgtasks-createsa-2"></A><li><p><b>To ensure that the keying material
is available to IPsec at reboot, add the keying material to the <tt>/etc/inet/secret/ipseckeys</tt> file.</b></p><p>The  lines  of the <tt>/etc/inet/secret/ipseckeys</tt> file are identical to the command line language.</p>
<ol Type="a"><li><p><b>For example, the <tt>/etc/inet/secret/ipseckeys</tt> file
on the <tt>enigma</tt> system would appear similar to the following:</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre># ipseckeys - This file takes the file format documented in 
#   ipseckey(1m).
#   Note that naming services might not be available when this file
#   loads, just like ipsecinit.conf.
#
# for outbound packets on enigma
add esp spi 0x8bcd1407 \
   src 192.168.116.16 dst 192.168.13.213  \
   encr_alg 3des \
   auth_alg md5  \
   encrkey  d41fb74470271826a8e7a80d343cc5aae9e2a7f05f13730d \
   authkey  e896f8df7f78d6cab36c94ccf293f031
#
# for inbound packets
add esp spi 0x122a43e4 \
   src 192.168.13.213 dst 192.168.116.16 \
   encr_alg 3des \
   auth_alg md5  \
   encrkey dd325c5c137fb4739a55c9b3a1747baa06359826a5e4358e \
   authkey ad9ced7ad5f255c9a8605fba5eb4d2fd</pre>
</td></table><br></li>
<li><p><b><A NAME="indexterm-1810"></A>Protect the file with read-only permissions.</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre># <tt><b>chmod 400 /etc/inet/secret/ipseckeys</b></tt></pre>
</td></table><br></li>
</ol>
</li>
<li><p><b>Repeat <A HREF="p109.html#ipsec-mgtasks-createsa-1">Step&nbsp;2</A> through <A HREF="p109.html#ipsec-mgtasks-createsa-2">Step&nbsp;7</A> on the <tt>partym</tt> system. </b></p><p>Use the same keying material that was used on <tt>enigma</tt>.</p>
<p>The keying material on the two systems <b>must</b> be
identical. As shown in the following example, only the comments in the <tt>ipseckeys</tt> file differ. The comments differ because <tt>dst enigma</tt> is
inbound on the <tt>enigma</tt> system, and outbound on the <tt>partym</tt> system.</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre># partym ipseckeys file
#
<tt><b># for inbound packets</b></tt>
add esp spi 0x8bcd1407 \
   src 192.168.116.16 dst 192.168.13.213  \
   encr_alg 3des \
   auth_alg md5  \
   encrkey  d41fb74470271826a8e7a80d343cc5aae9e2a7f05f13730d \
   authkey  e896f8df7f78d6cab36c94ccf293f031
#
<tt><b># for outbound packets</b></tt>
add esp spi 0x122a43e4 \
   src 192.168.13.213 dst 192.168.116.16 \
   encr_alg 3des \
   auth_alg md5  \
   encrkey dd325c5c137fb4739a55c9b3a1747baa06359826a5e4358e \
   authkey ad9ced7ad5f255c9a8605fba5eb4d2fd</pre>
</td></table><br></li>
</ol>
</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr class="suntab"><td></td><td align="right"><A HREF="p108.html"><IMG BORDER="0" ALT="Previous" SRC="graphics/prev.gif"> Previous</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="toc.html">Contents</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="idx.html">Index</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="p110.html">Next <IMG BORDER="0" ALT="Next" SRC="graphics/next.gif"></A></td></tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

