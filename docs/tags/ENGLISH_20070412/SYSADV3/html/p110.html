<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@16097-->
<head>
<META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=iso-8859-1">
<title>System Administration Guide: IP Services</title>
<link rel="stylesheet" type="text/css" href="css/default.css">
<!--stopindex-->
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<A href="toc.html">System Administration Guide: IP Services</A> <font color="red">&gt;&gt;</font> <nobr><A HREF="p107.html#ipsec-mgtasks-1">20.&nbsp;&nbsp;Configuring IPsec (Tasks)</A></nobr> <font color="red">&gt;&gt;</font> <nobr><A HREF="p107.html#ipsec-mgtasks-4">Protecting Traffic With IPsec</A></nobr>&nbsp;
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr class="grey1"><td></td><td align="right"><A HREF="p109.html"><IMG BORDER="0" ALT="Previous" SRC="graphics/prev.gif"> Previous</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="toc.html">Contents</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="idx.html">Index</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="p111.html">Next <IMG BORDER="0" ALT="Next" SRC="graphics/next.gif"></A></td></tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<A NAME="ipsec-mgtasks-11"></A><h3><IMG border="0" alt="Procedure" src="graphics/procedure.gif">How to Verify That Packets Are Protected
With IPsec</h3>
<A NAME="indexterm-1811"></A><A NAME="indexterm-1812"></A><A NAME="indexterm-1813"></A><A NAME="indexterm-1814"></A><p>To verify that packets are protected, test the connection with the <tt>snoop</tt> command. The following prefixes can appear in the <tt>snoop</tt> output:</p><ul><li><p><tt>AH:</tt> Prefix indicates that AH is protecting
the headers. You see <tt>AH:</tt> if you used <tt>auth_alg</tt> to
protect the traffic.</p>
</li>
<li><p><tt>ESP:</tt> Prefix indicates that encrypted data
is being sent. You see <tt>ESP:</tt> if you used <tt>encr_auth_alg</tt> or <tt>encr_alg</tt> to protect the traffic.</p>
</li>
</ul>
<h5>Before You Begin</h5><p>You must be superuser or have assumed an equivalent role to create the <tt>snoop</tt> output. You must have access to both systems to test the connection.</p>
<ol><li><p><b>On one system, such as <tt>partym</tt>, become superuser.</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre>% <tt><b>su -</b></tt>
Password: <em>Type root password</em>
# </pre>
</td></table><br></li>
<li><p><b>From the <tt>partym</tt> system, prepare to snoop
packets from a remote system.</b></p><p>In a terminal window on <tt>partym</tt>,
snoop the packets from the <tt>enigma</tt> system.</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre># <tt><b>snoop -v enigma</b></tt>
Using device /dev/hme (promiscuous mode)</pre>
</td></table><br></li>
<li><p><b>Send a packet from the remote system.</b></p><p>In another terminal
window, remotely log in to the <tt>enigma</tt> system. Provide
your password. Then, become superuser and send a packet from the <tt>enigma</tt> system
to the <tt>partym</tt> system. The packet should be captured
by the <tt>snoop -v enigma</tt> command.</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>% <tt><b>ssh enigma</b></tt>
Password: <em>Type your password</em>
% <tt><b>su -</b></tt>
Password: <em>Type root password</em>
# <tt><b>ping partym</b></tt></pre>
</td></table><br></li>
<li><p><b>Examine the <tt>snoop</tt> output.</b></p><p>On the <tt>partym</tt> system,
you should see output that includes <tt>AH</tt> and <tt>ESP</tt> information
after the initial <tt>IP</tt> header information. <tt>AH</tt> and <tt>ESP</tt> information that resembles the following shows that packets
are being protected:</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>IP:   Time to live = 64 seconds/hops
IP:   Protocol = 51 (AH)
IP:   Header checksum = 4e0e
IP:   Source address = 192.168.116.16, enigma
IP:   Destination address = 192.168.13.213, partym
IP:   No options
IP:
AH:  ----- Authentication Header -----
AH:
AH:  Next header = 50 (ESP)
AH:  AH length = 4 (24 bytes)
AH:  &lt;Reserved field = 0x0>
AH:  SPI = 0xb3a8d714
AH:  Replay = 52
AH:  ICV = c653901433ef5a7d77c76eaa
AH:
ESP:  ----- Encapsulating Security Payload -----
ESP:
ESP:  SPI = 0xd4f40a61
ESP:  Replay = 52
ESP:     ....ENCRYPTED DATA....

ETHER:  ----- Ether Header -----
...</pre>
</td></table><br></li>
</ol><A NAME="ipsec-mgtasks-18"></A><h3><IMG border="0" alt="Procedure" src="graphics/procedure.gif">How to Create a Role for Configuring Network
Security</h3>
<A NAME="indexterm-1815"></A><A NAME="indexterm-1816"></A><A NAME="indexterm-1817"></A><A NAME="indexterm-1818"></A><A NAME="indexterm-1819"></A><p>If you are using role-based access control (RBAC) to administer your
systems, you use this procedure to provide a network management or network
security role.</p>
<ol><li><p><b>Find the Network rights profiles in the local <tt>prof_attr</tt> database.</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre>% <tt><b>cd /etc/security</b></tt>
% <tt><b>grep Network prof_attr</b></tt>
Network Management:::Manage the host and network configuration ...
Network Security:::Manage network and host security ...
System Administrator:::...Network Management...</pre>
</td></table><br><p>The Network Management profile is a supplementary profile in the System
Administrator profile. If you have included the System Administrator rights
profile in a role, then that role can execute the commands in the Network
Management profile.</p>
</li>
<li><p><b><A NAME="indexterm-1820"></A><A NAME="indexterm-1821"></A>Determine which commands are in the Network Management rights
profile.</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre>% <tt><b>grep "Network Management" /etc/security/exec_attr</b></tt>
Network Management:solaris:cmd:::/usr/sbin/ifconfig:privs=sys_net_config
...
Network Management:suser:cmd:::/usr/sbin/snoop:uid=0</pre>
</td></table><br><p>The <tt>solaris</tt> policy commands run with privilege (<tt>privs=sys_net_config</tt>). The <tt>suser</tt> policy commands
run as superuser (<tt>uid=0</tt>).</p>
</li>
<li><p><b><A NAME="indexterm-1822"></A><A NAME="indexterm-1823"></A>Determine which commands are in the Network Security rights profile.</b></p><table cellpadding="4" border="1" cols="1" width="100%"><td><pre>% <tt><b>grep "Network Security" /etc/security/exec_attr</b></tt>
...
Network Security:solaris:cmd:::/usr/sbin/ipsecconf:privs=sys_net_config
...
Network Security:solaris:cmd:::/usr/sbin/ipseckey:privs=sys_net_config
...</pre>
</td></table><br></li>
<li><p><b>Create a role that includes the Network Security and the Network
Management rights profiles.</b></p><p>A role with both profiles can execute
the <tt>ifconfig</tt>, <tt>snoop</tt>, <tt>ipsecconf</tt>,
and <tt>ipseckey</tt> commands, among others, with appropriate privilege.</p>
<p>To create the role, assign the role to a user, and register the
changes with the name service, see "Configuring RBAC (Task Map)" in <i>System Administration Guide: Security Services</i>.</p>
</li>
</ol><A NAME="ipsec-mgtasks-vpn-2"></A><h2>Protecting a VPN With IPsec (Task Map)</h2>
<p><A NAME="indexterm-1824"></A><A NAME="indexterm-1825"></A><A NAME="indexterm-1826"></A>The following table points to procedures that configure IPsec
to protect traffic across the Internet. These procedures set up a secure virtual
private network (VPN) between two systems that are separated by the Internet.
One common use of this technology is to protect traffic between home workers
and their corporate office.</p>

<table cellspacing="5" border="1">
<tr><th scope="col"><p>Task</p></th><th scope="col"><p>Description</p></th><th scope="col"><p>For Instructions</p></th></tr>
<tr><td><p>Protect tunnel traffic in tunnel mode over IPv4</p></td><td><p>Protects traffic in tunnel mode between two
Solaris Express systems.</p><p>Also, protects traffic in tunnel mode between another platform and a  Solaris
Express system.</p></td><td><p><A HREF="p111.html#ipsec-mgtasks-23">How to Protect a VPN With an IPsec Tunnel in Tunnel Mode Over IPv4</A>&nbsp;</p></td></tr>
<tr><td><p>Protect tunnel traffic in tunnel mode over IPv6</p></td><td><p>Protects traffic in tunnel mode between two Solaris systems that are
using the IPv6 protocol.</p></td><td><p><A HREF="p112.html#ipsec-mgtasks-15">How to Protect a VPN With an IPsec Tunnel in Tunnel Mode Over IPv6</A>&nbsp;</p></td></tr>
<tr><td rowspan="2"><p>Protect tunnel traffic in transport mode over IPv4</p></td><td><p>Protects traffic in transport mode between two
Solaris Express systems.</p><p>Also, protects traffic in transport mode between a system that is running
an earlier version of the Solaris OS and a  Solaris
Express system.</p></td><td><p><A HREF="p113.html#ipsec-mgtasks-24">How to Protect a VPN With an IPsec Tunnel in Transport Mode Over IPv4</A>&nbsp;</p></td></tr>
<tr><td><p>Protects traffic by using the older syntax. This is useful when you
are communicating with a system that is running an earlier version of the Solaris OS.
This method simplifies comparing the configuration files on the two systems.</p></td><td><p><A HREF="p113.html#ipsec-mgtasks-29">Example 20-11</A>&nbsp;</p></td></tr>
<tr><td><p>Protect tunnel traffic in transport mode over IPv6</p></td><td><p>Protects traffic in transport mode between two Solaris systems that
are using the IPv6 protocol.</p></td><td><p><A HREF="p114.html#ipsec-mgtasks-26">How to Protect a VPN With an IPsec Tunnel  in Transport Mode Over IPv6</A>&nbsp;</p></td></tr>
</table><A NAME="ipsec-mgtasks-vpn-4"></A><h2>Protecting
a VPN With IPsec</h2>
<p><A NAME="indexterm-1827"></A>IPsec tunnels can protect a VPN. In Solaris Express, Developer Edition 2/07,
a tunnel can be in tunnel mode, or in transport mode. Tunnel mode is interoperable
with the implementation of IPsec by other vendors. Transport mode is interoperable
with earlier versions of the Solaris OS. For a discussion of tunnel modes, see <A HREF="p105.html#ipsec-ov-13">Transport and Tunnel Modes in IPsec</A>.</p>
<p><A NAME="indexterm-1828"></A>Tunnels in tunnel mode offer more fine-grained control of the
traffic. In tunnel mode, for an inner IP address, you can specify the particular
protection you want down to a single port. For possible IPsec policies, see
the examples that follow the tunnel diagram in <A HREF="p110.html#ipsec-mgtasks-fig-tunnel-1">Figure 20-1</A>.</p>
<A NAME="ipsec-mgtasks-fig-tunnel-1"></A><p><b>Figure 20-1 </b>IPsec Tunnel Diagram</p>
<IMG src="figures/IPsecTunnel.gif" class="figure" alt="Diagram shows a VPN that connects two LANs. Each LAN
has four subnets." title="Diagram shows a VPN that connects two LANs. Each LAN
has four subnets."><p>The following examples assume that the tunnel is configured for all
subnets of the LANs:</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>## Tunnel configuration ##
ifconfig ip.tun0 10.1.2.1 10.2.3.1 tsrc 192.168.1.10 tdst 192.168.2.10</pre>
</td></table><br><A NAME="ipsec-mgtasks-31"></A><p><b>Example 20-3 </b>Creating a Tunnel That All
Subnets Can Use</p>
<p><A NAME="indexterm-1829"></A>In this example, all traffic from the local LANs in Central in <A HREF="p110.html#ipsec-mgtasks-fig-tunnel-1">Figure 20-1</A>, can be tunneled
through Router 1 to Router 2, and then delivered to all local LANs of Overseas.
The traffic is encrypted with AES. </p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>## IPsec policy ##
{tunnel ip.tun0 negotiate tunnel} 
 ipsec {encr_algs aes encr_auth_algs md5 sa shared}</pre>
</td></table><br><A NAME="ipsec-mgtasks-33"></A><p><b>Example 20-4 </b>Creating a Tunnel That Connects Two
Subnets Only</p>
<p>In this example, only traffic between subnet <tt>10.1.2.0/24</tt> of
Central and subnet <tt>10.2.3.0/24</tt> of Overseas is tunneled
and encrypted. In the absence of other IPsec policies for Central, if Central
attempts to route any traffic for other LANs over this tunnel, the traffic
is dropped at Router 1.</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>## IPsec policy ##
{tunnel ip.tun0 negotiate tunnel laddr 10.1.2.0/24 raddr 10.2.3.0/24} 
 ipsec {encr_algs aes encr_auth_algs md5 sa shared}</pre>
</td></table><br><A NAME="ipsec-mgtasks-35"></A><p><b>Example 20-5 </b>Creating a Tunnel for Only
Email Traffic Between Two Subnets</p>
<p>In this example, a tunnel is created for email traffic only. The traffic
is delivered from <tt>10.1.2.0/24</tt> of Central to the email server
on the <tt>10.2.3.0/24</tt> subnet of the Overseas LAN. The email
is encrypted with Blowfish. The policies apply to the remote and local email
ports. The <tt>rport</tt> policy protects mail that Central sends
to the remote email port of Overseas. The <tt>lport</tt> policy
protects mail Central receives from Overseas on local port 25.</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>## IPsec policy for email from Central to Overseas ##
{tunnel ip.tun0 negotiate tunnel ulp tcp rport 25 
 laddr 10.1.2.0/24 raddr 10.2.3.0/24} 
 ipsec {encr_algs blowfish encr_auth_algs md5 sa shared}</pre>
</td></table><br><table cellpadding="4" border="1" cols="1" width="100%"><td><pre>## IPsec policy for email from Overseas to Central ##
{tunnel ip.tun0 negotiate tunnel ulp tcp lport 25 
 laddr 10.1.2.0/24 raddr 10.2.3.0/24} 
 ipsec {encr_algs blowfish encr_auth_algs md5 sa shared}</pre>
</td></table><br>
</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr class="suntab"><td></td><td align="right"><A HREF="p109.html"><IMG BORDER="0" ALT="Previous" SRC="graphics/prev.gif"> Previous</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="toc.html">Contents</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="idx.html">Index</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="p111.html">Next <IMG BORDER="0" ALT="Next" SRC="graphics/next.gif"></A></td></tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

