<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@16097-->
<head>
<META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=iso-8859-1">
<title>System Administration Guide: IP Services</title>
<link rel="stylesheet" type="text/css" href="css/default.css">
<!--stopindex-->
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<A href="toc.html">System Administration Guide: IP Services</A> <font color="red">&gt;&gt;</font> <nobr><A HREF="p103.html#ipsec-ov-1">19.&nbsp;&nbsp;IP Security Architecture (Overview)</A></nobr> <font color="red">&gt;&gt;</font> <nobr><A HREF="p104.html#ipsec-ov-7">IPsec Protection Mechanisms</A></nobr>&nbsp;
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr class="grey1"><td></td><td align="right"><A HREF="p104.html"><IMG BORDER="0" ALT="Previous" SRC="graphics/prev.gif"> Previous</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="toc.html">Contents</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="idx.html">Index</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="p106.html">Next <IMG BORDER="0" ALT="Next" SRC="graphics/next.gif"></A></td></tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<A NAME="ipsec-ov-8"></A><h3>Encapsulating Security Payload</h3>
<A NAME="indexterm-1656"></A><A NAME="indexterm-1657"></A><A NAME="indexterm-1658"></A><p>The <A HREF="p193.html#glossary-35">encapsulating security payload (ESP)</A> module
provides confidentiality over what the ESP encapsulates. ESP also provides
the services that AH provides. However, ESP only provides its protections
over the part of the datagram that ESP encapsulates. The authentication services
of ESP are optional. These services enable you to use ESP and AH together
on the same datagram without redundancy. Because ESP uses encryption-enabling
technology, ESP must conform to U.S. export control laws.</p>
<p><A NAME="indexterm-1659"></A><A NAME="indexterm-1660"></A>ESP encapsulates its data, so ESP only protects the data that
follows its beginning in the datagram, as shown in the following illustration.</p>
<IMG src="figures/IPsecHdr2.gif" class="figure" alt="Diagram shows the ESP header between the IP header and
the TCP header. The TCP header is encrypted by the ESP header." title="Diagram shows the ESP header between the IP header and
the TCP header. The TCP header is encrypted by the ESP header."><p>In a TCP packet, ESP encapsulates only the TCP header and its data.
If the packet is an IP-in-IP datagram, ESP protects the inner IP datagram.
Per-socket policy allows <b>self-encapsulation</b>, so ESP can
encapsulate IP options when ESP needs to.</p>
<p>If self-encapsulation
is set, a copy of the IP header is made to construct an IP-in-IP datagram.
For example, when self-encapsulation is not set on a TCP socket, the datagram
is sent in the following format:</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>[ IP(a -> b) <i>options</i> + TCP + data ]</pre>
</td></table><br><p>When self-encapsulation is set on that TCP socket, the datagram
is sent in the following format:</p>
<table cellpadding="4" border="1" cols="1" width="100%"><td><pre>[ IP(a -> b) + ESP [ IP(a -> b) <i>options</i> + TCP + data ] ]</pre>
</td></table><br><p>For further discussion, see <A HREF="p105.html#ipsec-ov-13">Transport and Tunnel Modes in IPsec</A>.</p>
<A NAME="ipsec-ov-10"></A><h4>Security Considerations When Using
AH and ESP</h4>
<p><A NAME="indexterm-1661"></A><A NAME="indexterm-1662"></A><A NAME="indexterm-1663"></A><A NAME="indexterm-1664"></A><A NAME="indexterm-1665"></A><A NAME="indexterm-1666"></A>The following table compares the protections that are provided
by AH and ESP.</p>
<A NAME="ipsec-ov-tbl-5"></A><p><b>Table 19-2 </b>Protections Provided
by AH and ESP in IPsec</p>

<table cellspacing="5" border="1">
<tr><th scope="col"><p>Protocol</p></th><th scope="col"><p>Packet Coverage</p></th><th scope="col"><p>Protection</p></th><th scope="col"><p>Against Attacks</p></th></tr>
<tr><td><p>AH</p></td><td><p>Protects packet from the IP header to the transport header</p></td><td><p>Provides strong integrity, data authentication:</p><ul><li><p>Ensures that the receiver receives exactly what the sender
sent</p></li>
<li><p>Is susceptible to replay attacks when an AH does not enable
replay protection</p></li>
</ul>
</td><td><p>Replay, cut-and-paste</p></td></tr>
<tr><td rowspan="3"><p>ESP</p></td><td rowspan="3"><p>Protects packet following the beginning of ESP in the datagram.</p></td><td><p>With encryption option, encrypts the IP datagram. Ensures confidentiality</p></td><td><p>Eavesdropping</p></td></tr>
<tr><td><p>With authentication option, provides the same protection as AH</p></td><td><p>Replay, cut-and-paste</p></td></tr>
<tr><td><p>With both options, provides strong integrity, data authentication, and
confidentiality</p></td><td><p>Replay, cut-and-paste, eavesdropping</p></td></tr>
</table><A NAME="ipsec-ov-11"></A><h3>Authentication and Encryption Algorithms in
IPsec</h3>
<p><A NAME="indexterm-1667"></A>IPsec security protocols use two types of algorithms, authentication
and encryption. The AH module uses authentication algorithms. The ESP module
can use encryption as well as authentication algorithms. You can obtain a
list of the algorithms on your system and their properties by using the <tt>ipsecalgs</tt> command. For more information, see the <tt>ipsecalgs</tt>(1M) man page.
You can also use the functions that are described in the <tt>getipsecalgbyname</tt>(3NSL) man page to retrieve the properties of algorithms.</p>
<p>IPsec on a Solaris system uses the Solaris cryptographic framework to
access the algorithms. The framework provides a central repository for algorithms,
in addition to other services. The framework enables IPsec to take advantage
of high performance cryptographic hardware accelerators. The framework also
provides resource control features. For example, the framework enables you
to limit the amount of CPU time spent in cryptographic operations in the kernel.
For more information, see the following:</p>
<ul><li><p>Chapter 12, "Solaris Cryptographic Framework (Overview)," in <i>System Administration Guide: Security Services</i></p>
</li>
<li><p>Chapter 8, "Introduction to the Solaris Cryptographic Framework," in <i>Solaris Security for Developers Guide</i></p>
</li>
</ul>
<A NAME="ipsec-ov-19"></A><h4>Authentication Algorithms in IPsec</h4>
<p><A NAME="indexterm-1668"></A><A NAME="indexterm-1669"></A><A NAME="indexterm-1670"></A>Authentication algorithms produce an integrity checksum value
or <b>digest</b> that is based on the data and a key. The AH
module uses authentication algorithms. The ESP module can use authentication
algorithms as well.</p>
<A NAME="ipsec-ov-20"></A><h4>Encryption Algorithms in IPsec</h4>
<p><A NAME="indexterm-1671"></A><A NAME="indexterm-1672"></A><A NAME="indexterm-1673"></A><A NAME="indexterm-1674"></A><A NAME="indexterm-1675"></A><A NAME="indexterm-1676"></A><A NAME="indexterm-1677"></A><A NAME="indexterm-1678"></A><A NAME="indexterm-1679"></A><A NAME="indexterm-1680"></A>Encryption algorithms encrypt data with a key. The ESP module
in IPsec uses encryption algorithms. The algorithms operate on data in units
of a <b>block size</b>. By default, the <A HREF="p193.html#glossary-37">DES</A>-CBC, 3DES-CBC, AES-CBC, and Blowfish-CBC
algorithms are installed. The key sizes that are supported by the AES-CBC
and Blowfish-CBC algorithms are limited to 128 bits.</p>
<p>AES-CBC and Blowfish-CBC algorithms that support key sizes that are
greater than 128 bits are available to IPsec when you install the Solaris
Encryption Kit. However, not all encryption
algorithms are available outside of the United States. The kit is available
on a separate CD that is <b>not</b> part of the Solaris 10 installation
box. The <i>Solaris 10 Encryption Kit Installation Guide</i> describes
how to install the kit. For more information, see the <A  HREF="http://www.sun.com/download">Sun Downloads</A> web site. To download the kit, click the Downloads
A-Z tab, then click the letter S. The Solaris 10 Encryption Kit is among the
first twenty entries.</p>
<A NAME="ipsec-ov-12"></A><h2>IPsec Protection Policies</h2>
<A NAME="indexterm-1681"></A><A NAME="indexterm-1682"></A><A NAME="indexterm-1683"></A><p>IPsec protection policies can use any of the security mechanisms. IPsec
policies can be applied at the following levels:</p>
<ul><li><p>On a system-wide level</p>
</li>
<li><p>On a per-socket level</p>
</li>
</ul>
<p><A NAME="indexterm-1684"></A>IPsec applies the system-wide policy to outbound datagrams and
inbound datagrams. Outbound datagrams are either sent with protection or without
protection. If protection is applied, the algorithms are either specific or
non-specific. You can apply some additional rules to outbound datagrams, because
of the additional data that is known by the system. Inbound datagrams can
be either accepted or dropped. The decision to drop or accept an inbound datagram
is based on several criteria, which sometimes overlap or conflict. Conflicts
are resolved by determining which rule is parsed first. The traffic is automatically
accepted, except when a policy entry states that traffic should bypass all
other policies.</p>
<p><A NAME="indexterm-1685"></A><A NAME="indexterm-1686"></A>The policy that normally protects a datagram can be bypassed.
You can either specify an exception in the system-wide policy, or you can
request a bypass in the per-socket policy. For traffic within a system, policies
are enforced, but actual security mechanisms are not applied. Instead, the
outbound policy on an intra-system packet translates into an inbound packet
that has had those mechanisms applied.</p>
<p><A NAME="indexterm-1687"></A><A NAME="indexterm-1688"></A><A NAME="indexterm-1689"></A><A NAME="indexterm-1690"></A>You use the <tt>ipsecinit.conf</tt> file and the <tt>ipsecconf</tt> command to configure IPsec policies. For details and examples,
see the <tt>ipsecconf</tt>(1M) man
page.</p>
<A NAME="ipsec-ov-13"></A><h2>Transport and Tunnel Modes in IPsec</h2>
<A NAME="indexterm-1691"></A><A NAME="indexterm-1692"></A><A NAME="indexterm-1693"></A><A NAME="indexterm-1694"></A><A NAME="indexterm-1695"></A><p>The IPsec standards
define two distinct modes of IPsec operation, transport mode and tunnel mode.
The modes do not affect the encoding of packets. The packets are protected
by AH, ESP, or both in each mode. The modes differ in policy application when
the inner packet is an IP packet.</p>
<ul><li><p>In transport mode, the outer header determines the IPsec policy
that protects the inner IP packet.</p>
</li>
<li><p>In tunnel mode, the inner IP packet determines the IPsec policy
that protects its contents.</p>
</li>
</ul>
<p><A NAME="indexterm-1696"></A>In transport mode, the outer header, the next header, and any
ports that the next header supports, can be used to determine IPsec policy.
In effect, IPsec can enforce different transport mode policies between two
IP addresses to the granularity of a single port. For example, if the next
header is TCP, which supports ports, IPsec policy can be set for a TCP port
of the outer IP address. Similarly, if the next header is an IP header, the
outer header and the inner IP header can be used to determine IPsec policy.</p>
<p><A NAME="indexterm-1697"></A>Tunnel mode works only on IP-in-IP datagrams. Tunneling in tunnel
mode can be useful when computer workers at home are connecting to a central
computer location. In tunnel mode, IPsec policy is enforced on the contents
of the inner IP datagram. Different IPsec policies can be enforced for different
inner IP addresses. That is, the inner IP header, its next header, and the
ports that the next header supports, can enforce a policy. Unlike transport
mode, in tunnel mode the outer IP header does not dictate the policy of its
inner IP datagram.</p>
<p>Therefore, in tunnel mode, IPsec policy can
be specified for subnets of a LAN behind a router and can be specified for
ports on those subnets. IPsec policy can also be specified for particular
IP addresses, that is, hosts, on those subnets. The ports of those hosts can
also have a specific IPsec policy. However, if a dynamic routing protocol
is run over a tunnel, neither subnet selection nor address selection should
be used, because the view of the network topology on the peer network could
change.  Changes would invalidate the static IPsec policy.  For examples of
tunneling procedures that include configuring static routes, see  <A HREF="p110.html#ipsec-mgtasks-vpn-4">Protecting a VPN With IPsec</A>.</p>
<p><A NAME="indexterm-1698"></A><A NAME="indexterm-1699"></A>In Solaris, tunnel mode can be enforced only on an IP tunneling
network interface. The <tt>ipsecconf</tt> command provides a <tt>tunnel</tt> keyword to select an IP tunneling network interface. When the <tt>tunnel</tt> keyword is present in a rule, all selectors that are specified
in that rule apply to the inner packet.</p>
<p>In transport mode, ESP, AH, or both
ESP and AH, can protect the datagram.</p>
<p><A HREF="p105.html#ipsec-ov-fig-5">Figure 19-3</A> shows an IP header with an unprotected TCP packet.</p>
<A NAME="ipsec-ov-fig-5"></A><p><b>Figure 19-3 </b>Unprotected IP Packet Carrying TCP Information</p>
<IMG src="figures/IPsecHdr1.gif" class="figure" alt="Diagram shows the IP header followed by the TCP header.
The TCP header is not protected." title="Diagram shows the IP header followed by the TCP header.
The TCP header is not protected."><p><A NAME="indexterm-1700"></A>In
transport mode, ESP protects the data as shown in <A HREF="p105.html#ipsec-ov-fig-7">Figure 19-4</A>.</p>
<A NAME="ipsec-ov-fig-7"></A><p><b>Figure 19-4 </b>Protected IP Packet Carrying TCP Information</p>
<IMG src="figures/IPsecHdr2.gif" class="figure" alt="Diagram shows the ESP header between the IP header and
the TCP header. The TCP header is encrypted by the ESP header." title="Diagram shows the ESP header between the IP header and
the TCP header. The TCP header is encrypted by the ESP header."><p><A NAME="indexterm-1701"></A>In
transport mode, AH protects the data as shown in <A HREF="p105.html#ipsec-ov-fig-8">Figure 19-5</A>.</p>
<A NAME="ipsec-ov-fig-8"></A><p><b>Figure 19-5 </b>Packet Protected by an Authentication Header</p>
<IMG src="figures/IPsecHdr3.gif" class="figure" alt="Diagram shows the AH header between the IP header and
the TCP header." title="Diagram shows the AH header between the IP header and
the TCP header."><p>AH actually covers the data before the data appears in the datagram.
Consequently, the protection that is provided by AH, even in transport mode,
covers some of the IP header.</p>
<p><A NAME="indexterm-1702"></A>In tunnel
mode, the entire datagram
is <b>inside</b> the protection of an IPsec header. The datagram in <A HREF="p105.html#ipsec-ov-fig-5">Figure 19-3</A> is protected in tunnel mode by an outer IPsec header, and in this case
ESP, as is
shown in <A HREF="p105.html#ipsec-ov-fig-6">Figure 19-6</A>.</p>
<A NAME="ipsec-ov-fig-6"></A><p><b>Figure 19-6 </b>IPsec Packet Protected in Tunnel Mode</p>
<IMG src="figures/IPsecHdr4.gif" class="figure" alt="Diagram shows the ESP header after the IP header and
before an IP header and a TCP header. The last 2 headers are protected by
encryption." title="Diagram shows the ESP header after the IP header and
before an IP header and a TCP header. The last 2 headers are protected by
encryption."><p>The <tt>ipsecconf</tt> command
includes keywords to set tunnels in tunnel mode or in transport mode.</p>
<ul><li><p>For details on per-socket policy, see the <tt>ipsec</tt>(7P) man page.</p>
</li>
<li><p>For an example of per-socket policy, see <A HREF="p108.html#ipsec-mgtasks-16">How to Secure a Web Server With IPsec</A>.</p>
</li>
<li><p>For more information about tunnels, see the <tt>ipsecconf</tt>(1M) man page.</p>
</li>
<li><p>For an example of tunnel configuration, see <A HREF="p111.html#ipsec-mgtasks-23">How to Protect a VPN With an IPsec Tunnel in Tunnel Mode Over IPv4</A>.</p>
</li>
</ul>

</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr class="suntab"><td></td><td align="right"><A HREF="p104.html"><IMG BORDER="0" ALT="Previous" SRC="graphics/prev.gif"> Previous</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="toc.html">Contents</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="idx.html">Index</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="p106.html">Next <IMG BORDER="0" ALT="Next" SRC="graphics/next.gif"></A></td></tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

