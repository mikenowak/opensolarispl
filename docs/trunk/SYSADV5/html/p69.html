<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@17046-->
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Adding New Object Mappings (NIS+ to LDAP) - System Administration Guide: Naming and Directory Services (DNS, NIS, and LDAP)</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2006-09-01">
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/ipg.css">
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<!--stopindex-->

<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<?GenHTML ReferencePage >System Administration Guide: Naming and Directory Services (DNS, NIS, and LDAP)<?GenHTML /ReferencePage> > <a href="p61.html">16.&nbsp;&nbsp;Transitioning From NIS+ to LDAP</a>
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr valign="bottom"><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr><td colspan="5"></td></tr>
<tr>
<td></td>
<td style="width: 60%">&nbsp;</td>
<td><a href="p68.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p70.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<a name="nisplus2ldap-60"></a><h3>Adding New Object Mappings (NIS+ to LDAP)</h3>
<p><a name="indexterm-587"></a>The template mapping file, <tt>/var/nis/NIS+LDAPmapping.template</tt>, contains mapping information for all standard NIS+ objects. In
order to support mapping of site or application specific objects, you will
need to add new mapping entries. This is a simple task for non-entry (that
is, directory, group, link, or table) objects, but can become complex for
entry objects, if the LDAP organization of the corresponding entry data differs
greatly from that used by NIS+. The following example shows the simple case.</p>
<a name="nisplus2ldap-proc-61"></a><h4><img src="graphics/procedure.gif"> How to Map Non-Entry Objects</h4>
<ol><li><a name="nisplus2ldap-step-62"></a><b>Find the fully qualified name of the
object to be mapped.</b><p>If this name resides under the domain name
specified by the <tt>nisplusLDAPbaseDomain</tt> attribute, you can
omit the portion that equals the <tt>nisplusLDAPbaseDomain</tt> value.</p><p>For example, if <tt>nisplusLDAPbaseDomain</tt> has the value <tt>some.domain.</tt>, and the object to be mapped is a table called <tt>nodeinfo.some.domain.</tt>, the object name can be shortened to <tt>nodeinfo</tt>.</p></li><li><a name="nisplus2ldap-step-63"></a><b>Invent a database id to identify the
object.</b><p>The database id must be unique for the mapping configuration
used, but is not otherwise interpreted. It does not show up in the LDAP data.
In order to reduce confusion with entry object mappings, create a database
id identifying the table object proper (not the table entries) using an explanatory
string like <tt>_table</tt> at the end.</p><p>For this example,
use the database id <tt>nodeinfo_table</tt>, and establish the connection
between the database id and the object in the standard mapping file location
(<tt>/var/nis/NIS+LDAPmapping</tt>) by adding the following.</p><pre>nisplusLDAPdatabaseIdMapping	nodeinfo_table:nodeinfo.some.domain.</pre><p>Assuming that <tt>nisplusLDAPbaseDomain</tt> is <tt>some.domain.</tt>, the following would also work.</p><pre>nisplusLDAPdatabaseIdMapping	nodeinfo_table:nodeinfo</pre></li><li><a name="nisplus2ldap-step-64"></a><b>Decide on a TTL for the object.</b><p>This is the time during which the <tt>rpc.nisd</tt> daemon
regards its local copy of the object as valid. When the TTL expires, the next
reference to the object will initiate an LDAP lookup to refresh the object.</p><p>There are two different TTL values. The first is set when the <tt>rpc.nisd</tt> daemon first loads the object from disk (after a reboot or restart),
and the second pertains to all refreshes from LDAP. The first TTL is selected
randomly from a configured range. For example, if <tt>nodeinfo_table</tt> should
be valid for a period of between one and three hours following initial load,
and for twelve hours thereafter, specify the following.</p><pre>nisplusLDAPentryTtl		nodeinfo_table:3600:10800:43200</pre></li><li><a name="nisplus2ldap-step-65"></a><b>Decide where the object data should
be stored in LDAP.</b><p>The template mapping file suggests putting
non-entry object data in the <tt>ou=nisPlus</tt> container.</p><p>If you use this scheme, and have not yet created the appropriate attribute,
object class, and container, see <a href="p67.html">Mapping NIS+ Objects Other Than Table Entries</a>.</p><p>For example, assume
you want to store the <tt>nodeinfo</tt> object in the <tt>ou=nisPlus,dc=some,dc=domain</tt> container, and that the LDAP entry should have the <tt>cn
nodeinfo</tt>. Create the following <tt>nisplusLDAPobjectDN</tt>.</p><pre>nisplusLDAPobjectDN	nodeinfo_table:\
				cn=nodeinfo,ou=nisPlus,dc=some,dc=domain?base?\
				objectClass=nisplusObjectContainer:\
				cn=nodeinfo,ou=nisPlus,dc=some,dc=domain?base?\
					objectClass=nisplusObjectContainer,\
					objectClass=top</pre><p>Since NIS+ replicas do not write data to LDAP, you can use the <tt>nisplusLDAPobjectDN</tt> above for both master and replicas.</p></li><li><a name="nisplus2ldap-step-66"></a><b>(Skip this step if the NIS+ object to
be mapped has not yet been created in NIS+.) Store the object data in LDAP.
You could use the <tt>rpc.nisd</tt> daemon for this purpose, but
it is easier to use the <tt>nisldapmaptest</tt>(1M) utility, as you can leave
the <tt>rpc.nisd</tt> daemon running.</b><pre># <tt><b>nisldapmaptest</b></tt> <tt>-m</tt> <tt><b>/var/nis/NIS+LDAPmapping</b></tt> <tt>-o</tt> <tt><b></b></tt><tt>-t</tt> <tt><b>nodeinfo</b></tt> <tt>-r</tt><tt><b></b></tt></pre><p>The <tt>-o</tt> option specifies the table object itself, not
the table entries.</p></li><li><a name="nisplus2ldap-step-67"></a><b>Verify that the object data is stored
in LDAP. (This example assumes the LDAP server is running on the local machine
at port <tt>389</tt>.)</b><pre># <tt><b>ldapsearch</b></tt> <tt>-b</tt> <tt><b>ou=nisPlus,dc=some,dc=domain cn=nodeinfo</b></tt></pre><p>The output would appear similar to the following.</p><pre>dn: cn=nodeinfo,ou=nisPlus,dc=some,dc=domain
objectclass: nisplusObjectContainer
objectclass: top
cn: nodeinfo
nisplusobject=&lt;<i>base 64 encoded data</i>></pre></li><li><a name="nisplus2ldap-step-68"></a><b>Restart the NIS+ service.</b><p>The service will start by using the new mapping information.
Do not forget to edit the <tt>/lib/svc/method/nisplus</tt> file
to add the <tt>-m</tt> and <tt>-Y</tt> options, or use the <tt>svcprop</tt> command, as appropriate. See <a href="p61.html#nisplus2ldap-66">NIS+ to LDAP Tools and the Service Management Facility</a> for more information.</p><pre># <tt><b>svcadm restart network/rpc/nisplus:default</b></tt></pre></li></ol><a name="nisplus2ldap-69"></a><h4>Adding Entry Objects</h4>
<p><tt>NIS+LDAPmapping</tt>(4) specifies the syntax and semantics
of table entry mapping in detail, and also provides examples that show how
to use each syntactic element. However, the simplest and least error-prone
approach is usually to identify an already existing mapping that is similar
to what you want to do, and then copy and modify that existing mapping.</p>
<p>For example, assume that you have an NIS+ table called <tt>nodeinfo</tt>,
which is used to store inventory and owner information for nodes. Assume that
the NIS+ table was created by the following command.</p>
<pre># <tt><b>nistbladm</b></tt> <tt>-c</tt> <tt><b></b></tt><tt>-D</tt> <tt><b>access=og=rmcd,nw=r</b></tt> <tt>-s</tt> <tt><b>: nodeinfo_tbl \</b></tt>
<tt><b>cname=S inventory=S owner= nodeinfo.`domainname`.</b></tt></pre><p>The <tt>cname</tt> column is expected to contain the canonical
name of the node. In other words, the same value as that of the <tt>cname</tt> column
in the <tt>hosts.org_dir</tt> table for the node.</p>
<p>Also assume that the corresponding information is kept in the <tt>ou=Hosts</tt> container in LDAP, and that the <tt>nodeInfo</tt> object
class (which is an invention for this example, and is not defined in any RFC)
has <tt>cn</tt> as a MUST attribute, and that <tt>nodeInventory</tt> and <tt>nodeOwner</tt> are MAY attributes.</p>
<p>In order to upload existing <tt>nodeinfo</tt> data to LDAP,
it will be convenient to create the new mapping attributes in a separate file.
You could, for example, use <tt>/var/nis/tmpmapping</tt>.</p>
<ol><li><p>Create a database id that identifies the NIS+ table to be
mapped.</p>
<pre>nisplusLDAPdatabaseIdMapping	nodeinfo:nodeinfo</pre></li>
<li><p>Set the TTL for entries in the <tt>nodeinfo</tt> table.
Since the information is expected to change only rarely, use a twelve hour
TTL. When the <tt>rpc.nisd</tt> daemon first loads the <tt>nodeinfo</tt> table from disk, the TTLs for entries in the table are randomly
selected to be between six and twelve hours.</p>
<pre>nisplusLDAPentryTtl		nodeinfo:21600:43200:43200</pre></li>
<li><p>Identify an existing mapping that has similar properties to
the one you want to create. In this example, mapping the attribute values
is trivial (straight assignment). Instead, the complication is that you store
the LDAP data in an existing container, so that you have to be careful during
removal of the <tt>nodeinfo</tt> data. You do not want to remove
the entire <tt>ou=Hosts</tt> entry, just the <tt>nodeInventory</tt> and <tt>nodeOwner</tt> attributes. You will need a special deletion rule set
for this purpose.</p>
<p>To summarize, you are looking for a mapping
that shares a container, and has a delete rule set. One possible candidate
is the <tt>netmasks</tt> mapping, which shares the <tt>ou=Networks</tt> container, and does have a delete rule set.</p>
</li>
<li><p>The template <tt>netmasks</tt> mapping has the default
mapping (from <tt>/var/nis/NIS+LDAPmapping.template</tt>) as follows.</p>
<pre>nisplusLDAPobjectDN	netmasks:ou=Networks,?one?objectClass=ipNetwork,\
 													ipNetMaskNumber=*:\
											ou=Networks,?one?objectClass=ipNetwork:
														dbid=netmasks_del</pre><p>Transferred to the new mapping for <tt>nodeinfo</tt>, the
database id should be <tt>nodeinfo</tt>, the container <tt>ou=Hosts</tt>, and the object class <tt>nodeInfo</tt>. Thus, the first
line of the <tt>nodeinfo</tt> mapping becomes the following.</p>
<pre>nisplusLDAPobjectDN	nodeinfo:ou=Hosts,?one?objectClass=nodeInfo,\</pre><p>The second line in the <tt>netmasks</tt> mapping is the part
of the search filter that selects only those <tt>ou=Networks</tt> entries
that contain the <tt>ipNetMaskNumber</tt> attribute. In this example,
select the <tt>ou=Hosts</tt> entries that have the following <tt>nodeInventory</tt> attribute.</p>
<pre>nodeInventory=*:\</pre><p>The third and fourth lines are the write portion of the <tt>nisplusLDAPobjectDN</tt>, and they specify where in LDAP <tt>nodeinfo</tt> data
is written, as well as the rule set that is used when <tt>nodeinfo</tt> data
is deleted. In this case, create a delete rule set identified by the database
id <tt>nodeinfo_del</tt>. Because you are always writing to an existing
entry in <tt>ou=Hosts</tt>, you only need to specify the object
class for the  <tt>nodeinfo</tt> data proper as follows.</p>
<pre>ou=Hosts,?one?objectClass=nodeInfo:\
								dbid=nodeinfo_del
	</pre><p>Putting it all together, our <tt>nisplusLDAPobjectDN</tt> is
the following.</p>
<pre>nisplusLDAPobjectDN	nodeinfo:ou=Hosts,?one?objectClass=nodeInfo,\
					 							nodeInventory=*:\
											ou=Hosts,?one?objectClass=nodeInfo:\
												dbid=nodeinfo_del</pre></li>
<li><p>Create the rule set that maps <tt>nodeinfo</tt> data
from NIS+ to LDAP. The template (from <tt>netmasks</tt>) is the
following.</p>
<pre>nisplusLDAPattributeFromColumn \
		netmasks:	dn=("ipNetworkNumber=%s,", addr), \
						ipNetworkNumber=addr, \
						ipNetmaskNumber=mask, \
						description=comment</pre><p>The <tt>ou=Hosts</tt> container has an additional complication
in this case, as RFC 2307 specifies the <tt>dn</tt> should contain
the IP address. However, the IP address is not stored in the <tt>nodeinfo</tt> table,
so you must obtain it in another manner. Fortunately, the <tt>crednode</tt> mapping
in the template file shows how to obtain the IP address.</p>
<pre>nisplusLDAPattributeFromColumn \
		crednode:	dn=("cn=%s+ipHostNumber=%s,", \
								(cname, "%s.*"), \
			ldap:ipHostNumber:?one?("cn=%s", (cname, "%s.*"))), \</pre><p>Thus, you can copy that portion of the <tt>crednode</tt> mapping.
In this case, however, the <tt>cname</tt> column value is the actual
host name (not the principal name), so you do not need to extract just a portion
of the <tt>cname</tt>. Making the obvious substitutions of attribute
and column names, the <tt>nodeinfo</tt> mapping becomes the following.</p>
<pre>nisplusLDAPattributeFromColumn \
		nodeinfo:	dn=("cn=%s+ipHostNumber=%s,", cname, \
			ldap:ipHostNumber:?one?("cn=%s", cname)), \
				nodeInventory=inventory, \
				nodeOwner=owner</pre></li>
<li><p>When mapping data from LDAP to NIS+, the template <tt>netmasks</tt> entry is as follows.</p>
<pre>nisplusLDAPcolumnFromAttribute \
		netmasks:	addr=ipNetworkNumber, \
				mask=ipNetmaskNumber, \
				comment=description</pre><p>After substituting attribute and column names, this result is the following.</p>
<pre>nisplusLDAPcolumnFromAttribute \
		nodeinfo:	cname=cn, \
				inventory=nodeInventory, \
				owner=nodeOwner</pre></li>
<li><p>The delete rule set for <tt>netmasks</tt> is as
follows.</p>
<pre>nisplusLDAPattributeFromColumn \
		netmasks_del:	dn=("ipNetworkNumber=%s,", addr), \
				ipNetmaskNumber=</pre><p>The above specifies that when a <tt>netmasks</tt> entry is
deleted in NIS+, the <tt>ipNetmaskNumber</tt> attribute in the corresponding <tt>ou=Networks</tt> LDAP entry is deleted. In this case, delete the <tt>nodeInventory</tt> and <tt>nodeOwner</tt> attributes. Therefore, using the <tt>dn</tt> specification from item (5) above, results in the following.</p>
<pre>nisplusLDAPattributeFromColumn \
		nodeinfo_del:	dn=("cn=%s+ipHostNumber=%s,", cname, \
			ldap:ipHostNumber:?one?("cn=%s", cname)), \
				nodeInventory=, \
				nodeOwner=</pre><p>The mapping information is complete.</p>
</li>
<li><p>The mapping information is complete. In order to begin using it, stop
and later start the <tt>rpc.nisd</tt> daemon.</p>
<pre># <tt><b>pkill rpc.nisd</b></tt></pre></li>
<li><p>Stop, and later start, the NIS+ service,
to begin using the mapping file.</p>
<pre># <tt><b>svcadm disable network/rpc/nisplus:default</b></tt></pre></li>
<li><p>If data is already in the NIS+ <tt>nodeinfo</tt> table,
upload that data to LDAP. Put the new <tt>nodeinfo</tt> mapping
information into a separate file, <tt>/var/nis/tmpmapping</tt>.</p>
<pre># <tt><b>/usr/sbin/rpc.nisd</b></tt> <tt>-D</tt> <tt><b></b></tt><tt>-m</tt> <tt><b>/var/nis/tmpmapping \</b></tt>
<tt><b></b></tt><tt>-x</tt> <tt><b>nisplusLDAPinitialUpdateAction=to_ldap \</b></tt>
<tt><b></b></tt><tt>-x</tt> <tt><b>nisplusLDAPinitialUpdateOnly=yes</b></tt></pre></li>
<li><p>Add the mapping information from the temporary file, <tt>/var/nis/tmpmapping</tt>, to the actual mapping file. Use an editor to do this, or append
the data (assuming the actual mapping file is <tt>/var/nis/NIS+LDAPmapping</tt>)
as follows.</p>
<pre># <tt><b>cp</b></tt> <tt>-p</tt> <tt><b>/var/nis/NIS+LDAPmapping \</b></tt>
<tt><b>/var/nis/NIS+LDAPmapping.backup</b></tt></pre><pre># <tt><b>cat /var/nis/tmpmapping >> /var/nis/NIS+LDAPmapping</b></tt></pre><hr>
<p><b>Caution - </b>Note the double arrow redirection, &ldquo;>>&rdquo;. A single
arrow, &ldquo;>&rdquo;, would overwrite the target file.</p>
<hr>
</li>
<li><p>Add the <tt>-m</tt> option to
the <tt>/lib/svc/method/nisplus</tt> file. Also add the <tt>-Y</tt> or <tt>-B</tt> options as needed. See <a href="p61.html#nisplus2ldap-66">NIS+ to LDAP Tools and the Service Management Facility</a> for more information.</p>
</li>
<li><p>Start the NIS+ service.</p>
<pre># <tt><b>svcadm enable network/rpc/nisplus:default</b></tt></pre></li>
<li><p>Restart the <tt>rpc.nisd</tt> daemon.
Add the <tt>-Y</tt> option if the <tt>rpc.nisd</tt> daemon
also serves NIS (YP) data as follows.</p>
<pre># <tt><b>/usr/sbin/rpc.nisd</b></tt> <tt>-m</tt> <tt><b>/var/nis/NIS+LDAPmapping</b></tt></pre></li>
</ol>

</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr valign="bottom">
<td></td>
<td style="width: 60%"></td>
<td><a href="p68.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p70.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2006 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

