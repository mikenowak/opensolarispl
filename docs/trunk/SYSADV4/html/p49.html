<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@17046-->
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title><tt>OPEN</tt> Share Support in NFS
Version 4 - System Administration Guide: Network Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2007-02-01">
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/ipg.css">
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<!--stopindex-->

<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<?GenHTML ReferencePage >System Administration Guide: Network Services<?GenHTML /ReferencePage> > <a href="p31.html">6.&nbsp;&nbsp;Accessing Network File Systems (Reference)</a> > <a href="p47.html#rfsrefer-45">How the NFS Service Works</a> > <a href="p48.html">Features in NFS Version 4</a>
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr valign="bottom"><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr><td colspan="5"></td></tr>
<tr>
<td></td>
<td style="width: 60%">&nbsp;</td>
<td><a href="p48.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p50.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<a name="rfsrefer-139"></a><h5><tt>OPEN</tt> Share Support in NFS
Version 4</h5>
<a name="indexterm-680"></a><p>The NFS version 4 protocol provides several file-sharing modes that
the client can use to control file access by other clients. A client can specify
the following:</p>
<ul><li><p><tt>DENY_NONE</tt> mode permits other clients read
and write access to a file.</p>
</li>
<li><p><tt>DENY_READ</tt> mode denies other clients read
access  to a file.</p>
</li>
<li><p><tt>DENY_WRITE</tt> mode denies other clients write
access to a file.</p>
</li>
<li><p><tt>DENY_BOTH</tt> mode denies other clients read
and write access to a file.</p>
</li>
</ul>
<p>The Solaris NFS version 4 server fully implements these file-sharing
modes. Therefore, if a client attempts to open a file in a way that conflicts
with the current share mode, the server denies the attempt by failing the
operation. When such attempts fail with the initiation of the open or create
operations, the Solaris NFS version 4 client receives a protocol error. This
error is mapped to the application error <tt>EACCES</tt>.</p>
<p>Even though the protocol provides several sharing modes, currently the
open operation in Solaris does not offer multiple sharing modes. When opening
a file, a Solaris NFS version 4 client can only use the <tt>DENY_NONE</tt> mode.</p>
<p>Also, even though the Solaris <tt>fcntl</tt> system call has
an <tt>F_SHARE</tt> command to control file sharing, the <tt>fcntl</tt> commands cannot be implemented correctly with NFS version 4.  If
you use these <tt>fcntl</tt> commands on an NFS version 4 client,
the client returns the <tt>EAGAIN</tt> error to the application.</p>
<a name="rfsrefer-140"></a><h5>Delegation in NFS Version 4</h5>
<a name="indexterm-681"></a><p>NFS version 4 provides both client support and server support for delegation.
Delegation is a technique by which the server delegates the management of
a file to a client. For example, the server could grant either a read delegation
or a write delegation to a client. Read delegations can be granted to multiple
clients at the same time, because these read delegations do not conflict with
each other. A write delegation can be granted to only one client, because
a write delegation conflicts with any file access by any other client.  While
holding a write delegation, the client would not send various operations to
the server because the client is guaranteed exclusive access to a file. Similarly,
the client would not send various operations to the server while holding a
read delegation. The reason is that the server guarantees that no client can
open the file in write mode. The effect of delegation is to greatly reduce
the interactions between the server and the client for delegated files. Therefore,
network traffic is reduced, and performance on the client and the server is
improved. Note, however, that the degree of performance improvement depends
on the kind of file interaction used by an application and the amount of network
and server congestion.</p>
<p>The decision about whether to grant a delegation is made entirely by
the server. A client does not request a delegation. The server makes decisions
about whether to grant a delegation, based on the access patterns for the
file. If a file has been recently accessed in write mode by several different
clients, the server might not grant a delegation. The reason is that this
access pattern indicates the potential for future conflicts.</p>
<p>A conflict occurs when a client accesses a file in a manner that is
inconsistent with the delegations that are currently granted for that file.
For example, if a client holds a write delegation on a file and a second client
opens that file for read or write access, the server recalls the first client's
write delegation. Similarly, if a client holds a read delegation and another
client opens the same file for writing, the server recalls the read delegation.
Note that in both situations, the second client is not granted a delegation
because a conflict now exists. When a conflict occurs, the server uses a callback
mechanism to contact the client that currently holds the delegation. On receiving
this callback, the client sends the file's updated state to the server and
returns the delegation. If the client fails to respond to the recall, the
server revokes the delegation. In such instances, the server rejects all operations
from the client for this file, and the client reports the requested operations
as failures. Generally, these failures are reported to the application as <tt>I/O</tt> errors.  To recover from these errors, the file must be closed
and then reopened. Failures from revoked delegations can occur when a network
partition exists between the client and the server while the client holds
a delegation.</p>
<p>Note that one server does not resolve access conflicts for a file that
is stored on another server.  Thus, an NFS server only resolves conflicts
for files that it stores. Furthermore, in response to conflicts that are caused
by clients that are running various versions of NFS, an NFS server can only
initiate recalls to the client that is running NFS version 4.  An NFS server
cannot initiate recalls for clients that are running earlier versions of NFS.</p>
<p>The process for detecting conflicts varies. For example, unlike NFS
version 4, because version 2 and version 3 do not have an open procedure,
the conflict is detected only after the client attempts to read, write, or
lock a file. The server's response to these conflicts varies also.  For example:</p>
<ul><li><p>For NFS version 3, the server returns the <tt>JUKEBOX</tt> error,
which causes the client to halt the access request and try again later. The
client prints the message <tt>File unavailable</tt>.</p>
</li>
<li><p>For NFS version 2, because an equivalent of the <tt>JUKEBOX</tt> error
does not exist, the server makes no response, which causes the client to wait
and then try again. The client prints the message <tt>NFS server not
responding</tt>.</p>
</li>
</ul>
<p>These conditions clear when the delegation conflict has been resolved.</p>
<p>By default, server delegation is enabled. You can disable delegation
by modifying the <tt>/etc/default/nfs</tt> file. For procedural
information, refer to <a href="p19.html#rfsadmin-965">How to Select Different Versions of NFS on a Server</a>.</p>
<p>No keywords are required for client delegation. The NFS version 4 callback
daemon, <tt>nfs4cbd</tt>, provides the callback service on the client.
This daemon is started automatically whenever a mount for NFS version 4 is
enabled. By default, the client provides the necessary callback information
to the server for all Internet transports that are listed in the <tt>/etc/netconfig</tt> system file. Note that if the client is enabled for IPv6 and if
the IPv6 address for the client's name can be determined, then the callback
daemon accepts IPv6 connections.</p>
<p>The callback daemon uses a transient program number and a dynamically
assigned port number.  This information is provided to the server, and the
server tests the callback path before granting any delegations. If the callback
path does not test successfully, the server does not grant delegations, which
is the only externally visible behavior.</p>
<p>Note that because callback information is embedded within an NFS version
4 request, the server is unable to contact the client through a device that
uses Network Address Translation (NAT).  Also, the callback daemon uses a
dynamic port number. Therefore, the server might not be able to traverse a
firewall, even if that firewall enables normal NFS traffic on port 2049. 
In such situations, the server does not grant delegations.</p>
<a name="gande"></a><h5>ACLs and <tt>nfsmapid</tt> in NFS Version
4</h5>
<a name="indexterm-682"></a><a name="indexterm-683"></a><a name="indexterm-684"></a><a name="indexterm-685"></a><p><a name="indexterm-686"></a>An access control list (ACL) provides better file security by
enabling the owner of a file to define file permissions for the file owner,
the group, and other specific users and groups. ACLs are set on the server
and the client by using the <tt>setfacl</tt> command. See the <tt>setfacl</tt>(1) man page. In NFS version 4,
the ID mapper, <tt>nfsmapid</tt>, is used to map user or group IDs
in ACL entries on a server to user or group IDs in ACL entries on a client.
The reverse is also true. The user and group IDs in the ACL entries must exist
on both the client and the server.</p>
<a name="gandx"></a><h5>Reasons for ID Mapping to Fail</h5>
<a name="indexterm-687"></a><p>The following situations can cause ID mapping to fail:</p>
<ul><li><p>If the user or group that exists in an ACL entry on the server
cannot be mapped to a valid user or group on the client, the user is not allowed
to read the ACL on the client.</p>
<p><a name="indexterm-688"></a>For example, when you issue the <tt>ls</tt> <tt>-l</tt> command,
you receive the error message, <tt>Permission denied</tt>, for the
files with user or group ID ACL entities that cannot be mapped from the server
to the client. The ID mapper was unable to map a user or group in the ACL.
If the ID mapper had been able to map the user or group, a plus (+) sign would
have appeared after the permissions in the files list that is produced by <tt>ls</tt> <tt>-l</tt>. For example:</p>
<pre>% ls -l
-rw-r--rw-+   1 luis    staff      11968 Aug 12  2005 foobar</pre><p><a name="indexterm-689"></a>Similarly, the <tt>getfacl</tt> command can return the <tt>Permission denied</tt> error message for the same reason. For more information
about this command, see the <tt>getfacl</tt>(1) man
page.</p>
</li>
<li><p>If the user or group ID in any ACL entry that is set on the
client cannot be mapped to a valid user or group ID on the server, the <tt>setfacl</tt> command can fail and return the <tt>Permission denied</tt> error
message.</p>
</li>
<li><p><a name="indexterm-690"></a>If the client and server have mismatched NFSMAPID_DOMAIN values,
ID mapping fails. For more information, see <a href="p31.html#rfsrefer-133">Keywords for the <tt>/etc/default/nfs</tt> File</a>.</p>
</li>
</ul>
<a name="ganeh"></a><h5>Avoiding ID Mapping Problems With ACLs</h5>
<a name="indexterm-691"></a><a name="indexterm-692"></a><p>To avoid ID mapping problems, do the following:</p>
<ul><li><p>Make sure that the value for NFSMAPID_DOMAIN is set correctly
in the <tt>/etc/default/nfs</tt> file.</p>
</li>
<li><p>Make sure that all user and group IDs in the ACL entries exist
on both the NFS version 4 client and server.</p>
</li>
</ul>
<a name="gandj"></a><h5>Checking for Unmapped User or Group IDs</h5>
<a name="indexterm-693"></a><a name="indexterm-694"></a><p>To determine if any user or group cannot be mapped on the server or
client, use the following script:</p>
<pre>#! /usr/sbin/dtrace -Fs

sdt:::nfs4-acl-nobody
{
     printf("validate_idmapping: (%s) in the ACL could not be mapped!", 
stringof(arg0));
}</pre><hr>
<p><b>Note - </b>The probe name that is used in this script is an interface that
could change in the future. For more information, see Stability Levels in <i>Solaris Dynamic Tracing Guide</i>.</p>
<hr>
<a name="gandn"></a><h5>Additional Information About ACLs or <tt>nfsmapid</tt></h5>
<p>See the following:</p>
<ul><li><p>Protecting Files With ACLs (Task Map) in <i>System Administration Guide: Security Services</i></p>
</li>
<li><p><a href="p33.html#rfsrefer-118"><tt>nfsmapid</tt> Daemon</a></p>
</li>
</ul>
<a name="rfsrefer-47"></a><h4>UDP and TCP Negotiation</h4>
<p>During initiation, the transport protocol is also negotiated. By default,
the first connection-oriented transport that is supported on both the client
and the server is selected. If this selection does not succeed, the first
available connectionless transport protocol is used. The transport protocols
that are supported on a system are listed in <tt>/etc/netconfig</tt>.
TCP is the connection-oriented transport protocol that is supported by the
release. UDP is the connectionless transport protocol.</p>
<p>When both the NFS protocol version and the transport protocol are determined
by negotiation, the NFS protocol version is given precedence over the transport
protocol. The NFS version 3 protocol that uses UDP is given higher precedence
than the NFS version 2 protocol that is using TCP. You can manually select
both the NFS protocol version and the transport protocol with the <tt>mount</tt> command.
See the <tt>mount_nfs</tt>(1M) man
page. Under most conditions, allow the negotiation to select the best options.</p>

</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr valign="bottom">
<td></td>
<td style="width: 60%"></td>
<td><a href="p48.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p50.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

