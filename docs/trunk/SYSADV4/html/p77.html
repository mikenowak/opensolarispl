<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><!-- GenHTML@17046-->
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1">
<title>Setting SMTP
to Use TLS - System Administration Guide: Network Services</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2007-02-01">
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/ipg.css">
</head>

<body leftmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff"  class="a0v0">
<!--stopindex-->

<a name="top"></a>

<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1">
<div class="a1v0">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com">sun.com</a>
<a href="http://docs.sun.com/" class="dividelink">docs.sun.com</a>
</span>
</td><td align="right" nowrap="nowrap">
<span class="toolbarlinks">
<a href="http://www.sun.com/MySun/">My Sun</a>
<a href="http://www.sun.com/worldwide/" class="dividelink">Worldwide Sites</a>
</span>
</td></tr>
</table>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.0 -->
<div class="a2" id="a2v0">
<div class="cornerTL">
<div class="cornerTR">
<div class="cornerBL">
<div class="cornerBR">
<div class="a2topiclinks">
<table cellpadding="1" cellspacing="0" border="0">
<tr valign="bottom">
<td><a href="http://www.sun.com/" title="Home Page"><img src="css/a.gif" alt="Home Page" width="104" height="58" border="0" class="sunlogo"></a></td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip1"></td>
<td class="navlinks" id="navlink1">
<div>
<a id="glink1" href="http://www.sun.com/products/">Products</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip2"></td>
<td class="navlinks" id="navlink2">
<div>
<a id="glink2" href="http://www.sun.com/downloads/">Downloads</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip3"></td><td class="navlinks" id="navlink3">
<div>
<a id="glink3" href="http://www.sun.com/service/">Service &amp; Solutions</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip4"></td><td class="navlinks" id="navlink4">
<div>
<a id="glink4" href="http://www.sun.com/support/">Support</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip5"></td><td class="navlinks" id="navlink5">
<div>
<a id="glink5" href="http://www.sun.com/training/">Training</a>
</div>
</td><td><img src="css/a.gif" alt="" width="1" height="1" border="0" id="ip6"></td><td class="navlinks" id="navlink6">
<div>
<a id="glink6" href="http://research.sun.com/">Research</a>
</div>
</td>
</tr>
</table>
</div>

</div></div></div></div>
</div>
<!-- END A2 COMPONENT V.0 -->

<!-- BEGIN BREADCRUMB -->
<div id="breadcrumb">
<?GenHTML ReferencePage >System Administration Guide: Network Services<?GenHTML /ReferencePage> > <a href="p72.html">13.&nbsp;&nbsp;Mail Services (Tasks)</a>
</div><br />
<!-- END BREADCRUMB -->

<!-- BEGIN WRAPPER TABLE, 1 COLUMN, MAIN -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tr valign="bottom"><td width="100%" valign="top">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr><td colspan="5"></td></tr>
<tr>
<td></td>
<td style="width: 60%">&nbsp;</td>
<td><a href="p76.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p78.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->

</td></tr>
<tr><td width="100%" valign="top">
<a name="skip2content"> </a>

<!--startindex-->
<div class="maincontent">
<a name="ganav"></a><h3>Setting SMTP
to Use TLS</h3>
<a name="indexterm-1159"></a><a name="indexterm-1160"></a><a name="indexterm-1161"></a><a name="indexterm-1162"></a><a name="indexterm-1163"></a><p>Starting in the Solaris 10 1/06
release, SMTP can use Transport Layer
Security (TLS) in version 8.13 of <tt>sendmail</tt>. This service to
SMTP servers and clients provides
private, authenticated communications
over the Internet, as well as protection
from eavesdroppers and attackers.
Note that this service is not enabled
by default. </p>
<a name="fxcty"></a><h4><img src="graphics/procedure.gif"> How to Set
SMTP to Use TLS</h4>
<p>The following procedure uses
sample data to show you how to set
up the certificates that enable <tt>sendmail</tt> to use TLS. For
more information, see <a href="p97.html#fvbrb">Support for Running SMTP With TLS in Version 8.13 of <tt>sendmail</tt></a>.</p>
<ol><li><b>Become superuser or assume
an equivalent role.</b><p>Roles
contain authorizations and privileged
commands. For more information about
roles, see Configuring RBAC (Task Map) in <i>System Administration Guide: Security Services</i>.
To configure a role with the Primary
Administrator profile, see Chapter 2, Working With the Solaris Management Console (Tasks), in <i>System Administration Guide: Basic Administration</i>.</p></li><li><b>Stop <tt>sendmail</tt>.</b><pre># <tt><b>svcadm -t disable network/smtp:sendmail</b></tt></pre></li><li><b>Set up the certificates
that enable <tt>sendmail</tt> to
use TLS.</b><ol><li><b>Complete the following:</b><pre># <tt><b>cd /etc/mail</b></tt>
# <tt><b>mkdir -p certs/CA</b></tt>
# <tt><b>cd certs/CA</b></tt>
# <tt><b>mkdir certs crl newcerts private</b></tt>
# <tt><b>echo "01" > serial</b></tt>
# <tt><b>cp /dev/null index.txt</b></tt>
# <tt><b>cp /etc/sfw/openssl/openssl.cnf .</b></tt></pre></li><li><b>Use your preferred text
editor to change the <tt>dir</tt> value
in the <tt>openssl.cnf</tt> file
from <tt>/etc/sfw/openssl</tt> to <tt>/etc/mail/certs/CA</tt>.</b></li><li><b><a name="indexterm-1164"></a>Use the <tt>openssl</tt> command-line
tool to implement TLS.</b><p>Note
that the following command line generates
interactive text.</p><pre># <tt><b>openssl req -new -x509 -keyout private/cakey.pem -out cacert.pem -days 365 \
-config openssl.cnf</b></tt>
Generating a 1024 bit RSA private key
.....................................++++++
.....................................++++++
writing new private key to 'private/cakey.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) []:<tt><b>US</b></tt>
State or Province Name (full name) []:<tt><b>California</b></tt>
Locality Name (eg, city) []:<tt><b>Menlo Park</b></tt>
Organization Name (eg, company) [Unconfigured OpenSSL Installation]:<tt><b>Sun Microsystems</b></tt>
Organizational Unit Name (eg, section) []:<tt><b>Solaris</b></tt>
Common Name (eg, YOUR name) []:<tt><b>somehost.somedomain.example.com</b></tt>
Email Address []:<tt><b>someuser@example.com</b></tt></pre><dl><dt><tt>req</tt></dt>
<dd><p>This command creates
and processes certificate requests.</p>
</dd>
<dt><tt>-new</tt></dt>
<dd><p>This <tt>req</tt> option
generates a new certificate request.</p>
</dd>
<dt><tt>-x509</tt></dt>
<dd><p>This <tt>req</tt> option
creates a self-signed certificate.</p>
</dd>
<dt><tt>-keyout</tt> <tt>private/cakey.pem</tt></dt>
<dd><p>This <tt>req</tt> option
enables you to assign <tt>private/cakey.pem</tt> as the file name for your
newly created private key.</p>
</dd>
<dt><tt>-out</tt> <tt>cacert.pem</tt></dt>
<dd><p>This <tt>req</tt> option
enables you to assign <tt>cacert.pem</tt> as your output file.</p>
</dd>
<dt><tt>-days</tt> <tt>365</tt></dt>
<dd><p>This <tt>req</tt> option
enables you to certify the certificate
for <tt>365</tt> days. The
default value is <tt>30</tt>.</p>
</dd>
<dt><tt>-config</tt> <tt>openssl.cnf</tt></dt>
<dd><p>This <tt>req</tt> option
enables you to specify <tt>openssl.cnf</tt> as the configuration file.</p>
</dd>
</dl>
<p>Note that this command requires
that you provide the following:</p>
<ul><li><p><tt>Country Name</tt>,
such as <tt>US</tt>.</p>
</li>
<li><p><tt>State or
Province Name</tt>, such as <tt>California</tt>.</p>
</li>
<li><p><tt>Locality
Name</tt>, such as <tt>Menlo
Park</tt>.</p>
</li>
<li><p><tt>Organization
Name</tt>, such as <tt>Sun
Microsystems</tt>.</p>
</li>
<li><p><tt>Organizational
Unit Name</tt>, such as <tt>Solaris</tt>.</p>
</li>
<li><p><tt>Common Name</tt>,
which is the machine's fully qualified
host name. For more information, see
the <tt>check-hostname</tt>(1M) man
page.</p>
</li>
<li><p><tt>Email Address</tt>,
such as <tt>someuser@example.com</tt>.</p>
</li>
</ul>
</li></ol></li><li>(Optional) <b>If
you need a new secure connection,
make a new certificate and sign the
new certificate with the certificate
authority.</b><ol><li><b>Make a new certificate.</b><pre># <tt><b>cd /etc/mail/certs/CA</b></tt>
# <tt><b>openssl req -nodes -new -x509 -keyout newreq.pem -out newreq.pem -days 365 \
-config openssl.cnf</b></tt>
Generating a 1024 bit RSA private key
..............++++++
..............++++++
writing new private key to 'newreq.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) []:<tt><b>US</b></tt>
State or Province Name (full name) []:<tt><b>California</b></tt>
Locality Name (eg, city) []:<tt><b>Menlo Park</b></tt>
Organization Name (eg, company) [Unconfigured OpenSSL Installation]:<tt><b>Sun Microsystems</b></tt>
Organizational Unit Name (eg, section) []:<tt><b>Solaris</b></tt>
Common Name (eg, YOUR name) []:<tt><b>somehost.somedomain.example.com</b></tt>
Email Address []:<tt><b>someuser@example.com</b></tt></pre><p>This command requires that you
provide the same information that
you provided in step 3c.</p><p>Note
that in this example, the certificate
and private key are in the file <tt>newreq.pem</tt>.</p></li><li><b>Sign the new certificate
with the certificate authority.</b><pre># <tt><b>cd /etc/mail/certs/CA</b></tt>
# <tt><b>openssl x509 -x509toreq -in newreq.pem -signkey newreq.pem -out tmp.pem</b></tt>
Getting request Private Key
Generating certificate request
# <tt><b>openssl ca -config openssl.cnf -policy policy_anything -out newcert.pem -infiles tmp.pem</b></tt>
Using configuration from openssl.cnf
Enter pass phrase for /etc/mail/certs/CA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 1 (0x1)
        Validity
            Not Before: Jun 23 18:44:38 2005 GMT
            Not After : Jun 23 18:44:38 2006 GMT
        Subject:
            countryName               = US
            stateOrProvinceName       = California
            localityName              = Menlo Park
            organizationName          = Sun Microsystems
            organizationalUnitName    = Solaris
            commonName                = somehost.somedomain.example.com
            emailAddress              = someuser@example.com
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                93:D4:1F:C3:36:50:C5:97:D7:5E:01:E4:E3:4B:5D:0B:1F:96:9C:E2
            X509v3 Authority Key Identifier: 
                keyid:99:47:F7:17:CF:52:2A:74:A2:C0:13:38:20:6B:F1:B3:89:84:CC:68
                DirName:/C=US/ST=California/L=Menlo Park/O=Sun Microsystems/OU=Solaris/\
                CN=someuser@example.com/emailAddress=someuser@example.com
                serial:00

Certificate is to be certified until Jun 23 18:44:38 2006 GMT (365 days)
Sign the certificate? [y/n]:<tt><b>y</b></tt>


1 out of 1 certificate requests certified, commit? [y/n]<tt><b>y</b></tt>
Write out database with 1 new entries
Data Base Updated
# <tt><b>rm -f tmp.pem</b></tt></pre><p>In this example the file <tt>newreq.pem</tt> contains the
unsigned certificate and private key.
The file <tt>newcert.pem</tt> contains
the signed certificate.</p><dl><dt><tt>x509</tt> utility</dt>
<dd><p>Displays certificate
information, converts certificates
to various forms, and signs certificate
requests</p>
</dd>
<dt><tt>ca</tt> application</dt>
<dd><p>Used to sign certificate
requests in a variety of forms and
to generate CRLs (certificate revocation
lists)</p>
</dd>
</dl>
</li></ol></li><li><b>Enable <tt>sendmail</tt> to
use the certificates by adding the
following lines to your <tt>.mc</tt> file.</b><pre><tt><b>define(`confCACERT_PATH', `/etc/mail/certs')dnl
define(`confCACERT', `/etc/mail/certs/CAcert.pem')dnl
define(`confSERVER_CERT', `/etc/mail/certs/MYcert.pem')dnl
define(`confSERVER_KEY', `/etc/mail/certs/MYkey.pem')dnl
define(`confCLIENT_CERT', `/etc/mail/certs/MYcert.pem')dnl
define(`confCLIENT_KEY', `/etc/mail/certs/MYkey.pem')dnl</b></tt></pre><p>For more information, see <a href="p97.html#fvbqb">Configuration File Options for Running SMTP With TLS</a>.</p></li><li><b>Rebuild and install your <tt>sendmail.cf</tt> file in your <tt>/etc/mail</tt> directory.</b><p>For detailed instructions, see <a href="p76.html">Building the <tt>sendmail.cf</tt> Configuration File</a>.</p></li><li><b>Create symbolic links
from the files you created with <tt>openssl</tt> to the files you
defined in your <tt>.mc</tt> file.</b><pre># <tt><b>cd /etc/mail/certs</b></tt>
# <tt><b>ln -s CA/cacert.pem CAcert.pem</b></tt>
# <tt><b>ln -s CA/newcert.pem MYcert.pem</b></tt>
# <tt><b>ln -s CA/newreq.pem MYkey.pem</b></tt></pre></li><li><b>For added security, deny
read permission to group and others
for <tt>MYkey.pem</tt>.</b><pre># <tt><b>chmod go-r MYkey.pem</b></tt></pre></li><li><b>Use a symbolic link to
install CA certs in the directory
assigned to <tt>confCACERT_PATH</tt>.</b><pre># <tt><b>C=CAcert.pem</b></tt>
# <tt><b>ln -s $C `openssl x509 -noout -hash &lt; $C`.0</b></tt></pre></li><li><b>For secure mail with other
hosts, install their host certificates.</b><ol><li><b>Copy the file defined
by the other host's <tt>confCACERT</tt> option
to <tt>/etc/mail/certs/</tt><i>host.domain</i><tt>.cert.pem</tt>.</b><p>Replace <i>host.domain</i> with the other host's
fully qualified host name.</p></li><li><b>Use a symbolic link to
install CA certs in the directory
assigned to <tt>confCACERT_PATH</tt>.</b><pre># <tt><b>C=</b></tt><i>host.domain</i><tt><b>.cert.pem</b></tt>
# <tt><b>ln -s $C `openssl x509 -noout -hash &lt; $C`.0</b></tt></pre><p>Replace <i>host.domain</i> with
the other host's fully qualified host
name.</p></li></ol></li><li><b>Restart <tt>sendmail</tt>.</b><pre># <tt><b>svcadm enable network/smtp:sendmail</b></tt></pre></li></ol><a name="fxjdn"></a>Example 13-1 <tt>Received:</tt> Mail
Header<p>The following is an example
of a <tt>Received:</tt> header
for secure mail with TLS.</p>
<pre>Received: from his.example.com ([IPv6:2001:db8:3c4d:15::1a2f:1a2b])
        by her.example.com (8.13.4+Sun/8.13.4) with ESMTP id j2TNUB8i242496
        (version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-SHA bits=256 verify=OK)
        for &lt;janepc@her.example.com>; Tue, 29 Mar 2005 15:30:11 -0800 (PST)
Received: from her.example.com (her.city.example.com [192.168.0.0])
        by his.example.com (8.13.4+Sun/8.13.4) with ESMTP id j2TNU7cl571102
        version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-SHA bits=256 verify=OK)
        for &lt;janepc@her.example.com>; Tue, 29 Mar 2005 15:30:07 -0800 (PST)</pre><p>Note that the value for <tt>verify</tt> is <tt>OK</tt>,
which means that the authentication
was successful. For more information,
see <a href="p97.html#fvbqm">Macros for Running SMTP With TLS</a>.</p>
<h6>See Also</h6><p>The following OpenSSL man pages:</p>
<ul><li><p><a href="http://www.openssl.org/docs/apps/openssl.html">openssl(1)</a>.</p>
</li>
<li><p><a href="http://www.openssl.org/docs/apps/req.html">req(1)</a>.</p>
</li>
<li><p><a href="http://www.openssl.org/docs/apps/x509.html">x509(1)</a>.</p>
</li>
<li><p><a href="http://www.openssl.org/docs/apps/ca.html">ca(1)</a>.</p>
</li>
</ul>

</div>
<!--stopindex-->

<!-- END CENTRAL COLUMN COMPONENTS -->
</td></tr>

<!-- BEGIN SPACER ROW -->
<tr><td><img src="css/a.gif" width="780" height="1" border="0" alt="" /></td></tr>
<!-- END SPACER ROW -->

<tr><td>

<!-- BEGIN PAGE CONTROL ROW -->
<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr valign="bottom">
<td></td>
<td style="width: 60%"></td>
<td><a href="p76.html"><img style="padding-right: 3px" src="graphics/prev.gif" border="0">Previous</a></td>
<td><a href="toc.html">Contents</a></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p78.html">Next<img style="padding-left: 3px" src="graphics/next.gif" border="0"></a></td>
</tr>
</table>
<!-- END PAGE CONTROL ROW -->
</td></tr>

</table>
<!-- END WRAPPER TABLE, 1 COLUMN, MAIN -->


<!-- BEGIN A5 COMPONENT V.0 -->
<div class="a5" id="a5v0">
<span class="footerlinks">
<a href="http://www.sun.com/company/">Company Info</a>
<a href="http://www.sun.com/contact/">Contact</a>
<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>
<a href="http://www.sun.com/privacy/">Privacy</a>

<span class="footercopy">Copyright 1994-2007 Sun Microsystems, Inc.</span>
</span>
</div>
<!-- END A5 COMPONENT V.0 -->

</body>
</html>

