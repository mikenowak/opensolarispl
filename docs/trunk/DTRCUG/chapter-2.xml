<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML//EN"
"docbook.dtd" [
<!ENTITY % xinclude SYSTEM "xinclude.mod">
%xinclude;
]>
<chapter version="5.0" xmlns="http://docbook.org/ns/docbook" xml:id="gbxwv">
  <title>Podstawy DTrace</title>

  <toc>
    <para>W rozdziale tym przedstawiono DTrace oraz kilka przykładów prostych
    zadań.</para>
  </toc>

  <sect1 xml:id="gcfah">
    <title>Drukowanie sond</title>

    <para>Wszystkie sondy DTrace można wydrukować opcją <option>l</option>
    komendy <command>dtrace</command>:</para>

    <programlisting># <emphasis role="strong">dtrace -l</emphasis>
ID   PROVIDER    MODULE        FUNCTION NAME
 1     dtrace                           BEGIN
 2     dtrace                           END
 3     dtrace                           ERROR
 4    syscall                     nosys entry
 5    syscall                     nosys return
 6    syscall                     rexit entry
 7    syscall                     rexit return
 8    syscall                   forkall entry
 9    syscall                   forkall return
10    syscall                      read entry
11    syscall                      read return
...</programlisting>

    <para>Obliczenie wszystkich sond dostępnych w systemie:</para>

    <programlisting># <emphasis role="strong">dtrace -l | wc -l</emphasis>
</programlisting>

    <para>Ilość sond w systemie może się różnić, w zależności od wersji
    systemu operacyjnego oraz zainstalowanego oprogramowania. Niektóre sondy
    nie podają nic w kolumnie <literal>MODULE</literal> lub
    <literal>FUNCTION</literal>, na przykład sondy <literal>BEGIN</literal> i
    <literal>END</literal> z poprzedniego przykładu. Sondy takie nie są
    powiązane z jakąś konkretną funkcją lub miejscem w programie. Reprezentują
    raczej bardziej abstrakcyjne pojęcia, jak początek lub koniec śledzenia.
    Sonda, która ma w nazwie moduł i funkcję nazywa się <emphasis>sondą
    osadzoną (ang. anchored probe)</emphasis>. Sonda niepowiązana z modułem i
    funkcją jest <emphasis>sondą nieosadzoną (ang. unanchored
    probe)</emphasis>.</para>

    <para>Można użyć dodatkowych opcji do drukowania konkretnych sond, jak w
    poniższych przykładach.</para>

    <example xml:id="gcfac">
      <title>Drukowanie sond ze względu na pewne funkcje</title>

      <para>Można wydrukować listę sond powiązanych z pewną funkcją podając
      nazwę tej funkcji DTrace´owi z opcją <option> f</option>.</para>

      <programlisting># <emphasis role="strong">dtrace -l -f cv_wait</emphasis>
ID      PROVIDER        MODULE        FUNCTION NAME
12921        fbt       genunix         cv_wait entry
12922        fbt       genunix         cv_wait return</programlisting>
    </example>

    <example xml:id="gcfao">
      <title>Drukowanie sond ze względu na pewne moduły</title>

      <para>Można wydrukować listę sond powiązanych z pewnym modułem podając
      nazwę tego modułu DTrace´owi z opcją <option> m</option>.</para>

      <programlisting># <emphasis role="strong">dtrace -l -m sd</emphasis>
ID      PROVIDER        MODULE        FUNCTION NAME
17147        fbt            sd          sdopen entry
17148        fbt            sd          sdopen return
17149        fbt            sd         sdclose entry
17150        fbt            sd         sdclose return
17151        fbt            sd      sdstrategy entry
17152        fbt            sd      sdstrategy return
...</programlisting>
    </example>

    <example xml:id="gcfaf">
      <title>Drukowanie sond ze względu na nazwę</title>

      <para>Można wydrukować listę sond o pewnej nazwie, podając tę nazwę
      DTrace´owi z opcją <option> n</option>.</para>

      <programlisting># <emphasis role="strong">dtrace -l -n BEGIN</emphasis>
ID      PROVIDER        MODULE        FUNCTION NAME
1         dtrace                               BEGIN</programlisting>
    </example>

    <example xml:id="gcfag">
      <title>Drukowanie sond ze względu na dostawcę</title>

      <para>Można wydrukować listę sond powiązanych z pewnym dostawcą podając
      nazwę tego dostawcy DTrace´owi z opcją <option> P</option>.</para>

      <programlisting># <emphasis role="strong">dtrace -l -P lockstat</emphasis>
ID        PROVIDER        MODULE             FUNCTION NAME
469       lockstat       genunix          mutex_enter adaptive-acquire
470       lockstat       genunix          mutex_enter adaptive-block
471       lockstat       genunix          mutex_enter adaptive-spin
472       lockstat       genunix           mutex_exit adaptive-release
473       lockstat       genunix        mutex_destroy adaptive-release
474       lockstat       genunix       mutex_tryenter adaptive-acquire
...</programlisting>
    </example>

    <example xml:id="gcfad">
      <title>Kilku dostawców obsługujących pewne funkcje lub moduły</title>

      <para>Pewne funkcje lub moduły mogą być obsługiwane przez kilku
      dostawców, jak pokazano w poniższym przykładzie.</para>

      <programlisting># <emphasis role="strong">dtrace -l -f read</emphasis>
ID        PROVIDER        MODULE             FUNCTION NAME
  10       syscall                               read entry
  11       syscall                               read return
4036       sysinfo       genunix                 read readch
4040       sysinfo       genunix                 read sysread
7885           fbt       genunix                 read entry
7886           fbt       genunix                 read return</programlisting>
    </example>

    <para>Powyżej widać, że wynik komendy drukuje następujące
    informacje:</para>

    <itemizedlist>
      <listitem>
        <para>Unikalny identyfikator liczbowy (ID) sondy</para>

        <note>
          <para>ID jest unikalne tylko w konkretnym wydaniu systemu Solaris
          lub dla konkretnego zestawu łat.</para>
        </note>
      </listitem>

      <listitem>
        <para>Nazwa dostawcy</para>
      </listitem>

      <listitem>
        <para>Nazwa modułu, jeśli dotyczy</para>
      </listitem>

      <listitem>
        <para>Nazwa funkcji, jeśli dotyczy</para>
      </listitem>

      <listitem>
        <para>Nazwa sondy</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="gcfar">
    <title>Wskazywanie sond w DTrace</title>

    <para>Można wskazać konkretną sondę przez podanie wszystkich czterech
    elementów identyfikatora sonda. Format jest następujący:
    <emphasis>dostawca:moduł:funkcja:nazwa</emphasis>. Pusty element w czwórce
    nazywającej sondę oznacza dowolne dopasowanie. Na przykład nazwa
    <command>fbt::alloc:entry</command> wskazuje sondę o następujących
    atrybutach:</para>

    <itemizedlist>
      <listitem>
        <para>Sonda musi pochodzić od dostawcy <literal>fbt</literal></para>
      </listitem>

      <listitem>
        <para>Może znajdować się dowolnym module</para>
      </listitem>

      <listitem>
        <para>Musi być w funkcji <literal>alloc</literal></para>
      </listitem>

      <listitem>
        <para>Musi nazywać się <literal>entry</literal></para>
      </listitem>
    </itemizedlist>

    <para>Elementy po lewej stronie czwórki są opcjonalne. Specyfikacja
    <literal>::open:entry</literal> jest równoznaczna z
    <literal>open:entry</literal>. Obydwie oznaczają sondy
    <literal>entry</literal> w funkcji <literal>open</literal> we wszystkich
    modułach jądra.</para>

    <programlisting># <emphasis role="strong">dtrace -l -n open:entry</emphasis>
  ID      PROVIDER        MODULE             FUNCTION NAME
  14       syscall                               open entry
7386           fbt       genunix                 open entry</programlisting>

    <para>Sondy można też wskazywać przy użyciu składni wyrażeń regularnych
    podobnej do opisanej w sekcji <emphasis>File Name Generation</emphasis>
    strony man <literal remap="137">sh(1)</literal>. Składnia obsługuje
    specjalne znaki <literal>*</literal>, <literal>?</literal>,
    <literal>[</literal> i <literal>]</literal>. Opis sondy
    <literal>syscall::open*:entry</literal> oznacza zarówno wywołanie
    systemowe <literal>open</literal> jak i <literal>open64</literal>. Znak
    <literal>?</literal> oznacza dowolny jeden znak w nazwie.
    <literal>[</literal> i <literal>]</literal> używane są do wskazania grupy
    lub zakresu znaków.</para>
  </sect1>

  <sect1 xml:id="gcfay">
    <title>Włączanie sond</title>

    <para>Sondy włącza się komendą <command>dtrace</command> bez opcji
    <option> l</option>. Bez dalszych wskazówek DTrace wykonuje domyślną akcję
    przy odpalaniu sondy. Domyślna akcja wskazuje tylko, ze dana sonda
    odpaliła i nie zapisuje żadnych innych informacji. Poniższa komenda włącza
    wszystkie sondy w module <command>sd</command>.</para>

    <example xml:id="gcfbm">
      <title>Włączanie sond na podstawie modułu</title>

      <programlisting># <emphasis role="strong">dtrace -m sd</emphasis>
CPU     ID                     FUNCTION:NAME
  0  17329           sd_media_watch_cb:entry
  0  17330          sd_media_watch_cb:return
  0  17167                      sdinfo:entry
  0  17168                     sdinfo:return
  0  17151                  sdstrategy:entry
  0  17152                 sdstrategy:return
  0  17661          ddi_xbuf_qstrategy:entry
  0  17662         ddi_xbuf_qstrategy:return
  0  17649                xbuf_iostart:entry
  0  17341            sd_xbuf_strategy:entry
  0  17385                sd_xbuf_init:entry
  0  17386               sd_xbuf_init:return
  0  17342           sd_xbuf_strategy:return
  0  17177     sd_mapblockaddr_iostart:entry
  0  17178    sd_mapblockaddr_iostart:return
  0  17179               sd_pm_iostart:entry
  0  17365                 sd_pm_entry:entry
  0  17366                sd_pm_entry:return
  0  17180              sd_pm_iostart:return
  0  17181             sd_core_iostart:entry
  0  17407         sd_add_buf_to_waitq:entry
...</programlisting>

      <para>Wynik w powyższym przykładzie pokazuje domyślną akcję, drukującą
      numer procesora, na którym odpaliła sonda, numeryczne ID sondy
      przydzielone przez DTrace, funkcja, w której odpaliła sonda i nazwa
      sondy.</para>
    </example>

    <example xml:id="gcfcx">
      <title>Włączanie sond ze względu na dostawcę</title>

      <programlisting># <emphasis role="strong">dtrace -P syscall</emphasis>
dtrace: description 'syscall' matched 452 probes
CPU     ID                     FUNCTION:NAME
  0     99                      ioctl:return
  0     98                       ioctl:entry
  0     99                      ioctl:return
  0     98                       ioctl:entry
  0     99                      ioctl:return
  0    234                   sysconfig:entry
  0    235                  sysconfig:return
  0    234                   sysconfig:entry
  0    235                  sysconfig:return
  0    168                   sigaction:entry
  0    169                  sigaction:return
  0    168                   sigaction:entry
  0    169                  sigaction:return
  0     98                       ioctl:entry
  0     99                      ioctl:return
  0    234                   sysconfig:entry
  0    235                  sysconfig:return
  0     38                         brk:entry
  0     39                        brk:return
...</programlisting>
    </example>

    <example xml:id="gcfbu">
      <title>Włączanie sond ze względu na nazwę</title>

      <programlisting># <emphasis role="strong">dtrace -n zfod</emphasis>
dtrace: description 'zfod' matched 3 probes
CPU     ID                     FUNCTION:NAME
  0   4080                    anon_zero:zfod
  0   4080                    anon_zero:zfod
<emphasis role="strong">^C</emphasis>
</programlisting>
    </example>

    <example xml:id="gcfcs">
      <title>Włączanie sond ze względu na pełną nazwę</title>

      <programlisting># <emphasis role="strong">dtrace -n clock:entry</emphasis>
dtrace: description 'clock:entry' matched 1 probe
CPU     ID                     FUNCTION:NAME
  0   4198                       clock:entry
<emphasis role="strong">^C</emphasis>
</programlisting>
    </example>
  </sect1>

  <sect1 xml:id="gcfbn">
    <title>Podstawy akcji DTrace</title>

    <para>Akcje umożliwiają DTrace´owi współpracę z systemem poza frameworkiem
    DTrace. Najczęściej używana akcja to zapisywanie danych do bufora DTrace.
    Inne akcje mogą zatrzymać proces, wysłać dla procesu sygnał lub wyłączyć
    śledzenie. Akcje ingerujące w stan systemu nazywane są <emphasis>akcjami
    niszczącymi (ang. destructive actions)</emphasis>. Akcje zapisujące dane
    domyślnie zapisują dane do <emphasis>głównego bufora (ang. principal
    buffer)</emphasis>. Główny bufor jest obecny w każdym wywołaniu DTrace i
    jest zawsze alokowany lokalnie dla procesora. Bufor i śledzenie można
    ograniczyć do jednego procesora opcją <option>cpu</option>. Więcej
    informacji o buforowaniu w DTrace w <olink remap="external"
    targetdoc="817-6223" targetptr="chp-buf">Chapter 11, <citetitle
    remap="chapter">Buffers and Buffering,</citetitle> w <citetitle
    remap="book">Solaris Dynamic Tracing Guide</citetitle></olink>.</para>

    <para>Poniższe przykłady wykorzystują wbudowane typy danych D w skryptach
    D. Pewne najczęściej wykorzystywane zmienne w D podano poniżej:</para>

    <variablelist>
      <varlistentry>
        <term><literal>pid</literal></term>

        <listitem>
          <para>Zmienna zawiera ID aktualnego procesu.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><literal>execname</literal></term>

        <listitem>
          <para>Zawiera nazwę aktualnie wykonywanego pliku.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><literal>timestamp</literal></term>

        <listitem>
          <para>Czas od startu systemu wyrażony w nanosekundach.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><literal>curthread</literal></term>

        <listitem>
          <para>Wskaźnik do struktury <literal>kthread_t</literal>
          reprezentującej aktualny wątek.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><literal>probemod</literal></term>

        <listitem>
          <para>Moduł zawierający aktualną sondę.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><literal>probefunc</literal></term>

        <listitem>
          <para>Nazwa funkcji zawierającej aktualną sondę.</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><literal>probename</literal></term>

        <listitem>
          <para>Zmienna zawiera nazwę aktualnej sondy.</para>
        </listitem>
      </varlistentry>
    </variablelist>

    <para>Kompletna lista wbudowanych zmiennych języka D w Zmiennych.</para>

    <para>Język D zawiera również wbudowane funkcje wykonujące pewne akcje.
    Kompletna lista funkcji w <olink remap="external" targetdoc="817-6223"
    targetptr="chp-actsub">Chapter 10, <citetitle remap="chapter">Actions and
    Subroutines,</citetitle> w <citetitle remap="book">Solaris Dynamic Tracing
    Guide</citetitle> </olink>. Funkcja <function>trace</function> zapisuje
    wynik wyrażenia D do bufora, jak w poniższym przykładzie:</para>

    <itemizedlist>
      <listitem>
        <para><literal>trace(pid)</literal> śledzi ID aktualnego
        procesu</para>
      </listitem>

      <listitem>
        <para><literal>trace(execname)</literal> śledzi nazwę aktualnie
        wykonywanego pliku</para>
      </listitem>

      <listitem>
        <para><literal>trace(curthread-&gt;t_pri)</literal> śledzi pole
        <literal>t_pri</literal> aktualnego wątku</para>
      </listitem>

      <listitem>
        <para><literal>trace(probefunc)</literal> śledzi nazwę funkcji
        aktualnej sondy</para>
      </listitem>
    </itemizedlist>

    <para>Do wskazania sondzie konkretnej akcji do wykonania po odpaleniu służą
    klamry <literal>{}</literal>, jak w poniższym przykładzie.</para>

    <example xml:id="gcfdz">
      <title>Wskazywanie sondzie żądanej akcji</title>

      <programlisting># <emphasis role="strong">dtrace -n 'readch {trace(pid)}'</emphasis>
dtrace: description 'readch ' matched 4 probes
CPU     ID                     FUNCTION:NAME
  0   4036                       read:readch          2040
  0   4036                       read:readch          2177
  0   4036                       read:readch          2177
  0   4036                       read:readch          2040
  0   4036                       read:readch          2181
  0   4036                       read:readch          2181
  0   4036                       read:readch             7
...</programlisting>

      <para xml:id="gcfdq">W ostaniej kolumnie wydruku pojawia się
      identyfikator procesu (PID), ponieważ zażądano od sondy akcji
      <literal>trace(pid)</literal>.</para>
    </example>

    <example xml:id="gcfel">
      <title>Śledzenie nazwy wykonywanego pliku</title>

      <programlisting># <emphasis role="strong">dtrace -m 'ufs {trace(execname)}'</emphasis>
dtrace: description 'ufs ' matched 889 probes
CPU     ID                     FUNCTION:NAME
  0  14977                  ufs_lookup:entry            ls
  0  15748                 ufs_iaccess:entry            ls
  0  15749                ufs_iaccess:return            ls
  0  14978                 ufs_lookup:return            ls
...
  0  15007                    ufs_seek:entry         utmpd
  0  15008                   ufs_seek:return         utmpd
  0  14963                   ufs_close:entry         utmpd
<emphasis role="strong">^C</emphasis>
</programlisting>
    </example>

    <example xml:id="gcfgm">
      <title>Śledzenie czasu wejścia do wywołania systemowego</title>

      <programlisting># <emphasis role="strong">dtrace -n 'syscall:::entry {trace(timestamp)}'</emphasis>
dtrace: description 'syscall:::entry ' matched 226 probes
CPU     ID                     FUNCTION:NAME
  0    312                      portfs:entry    157088479572713
  0     98                       ioctl:entry    157088479637542
  0     98                       ioctl:entry    157088479674339
  0    234                   sysconfig:entry    157088479767243
...
  0     98                       ioctl:entry    157088481033225
  0     60                       fstat:entry    157088481050686
  0     60                       fstat:entry    157088481074680
<emphasis role="strong">^C</emphasis>
</programlisting>
    </example>

    <example xml:id="gcfgt">
      <title>Wskazywanie kilku akcji</title>

      <para>Kilka akcji do wykonania wskazuje się podając jedną po drugiej,
      oddzielone średnikiem (<literal>;</literal>).</para>

      <programlisting># <emphasis role="strong">dtrace -n 'zfod {trace(pid);trace(execname)}'</emphasis>
dtrace: description 'zfod ' matched 3 probes
CPU     ID                     FUNCTION:NAME
  0   4080                    anon_zero:zfod    2195   dtrace
  0   4080                    anon_zero:zfod    2195   dtrace
  0   4080                    anon_zero:zfod    2195   dtrace
  0   4080                    anon_zero:zfod    2195   dtrace
  0   4080                    anon_zero:zfod    2195   dtrace
  0   4080                    anon_zero:zfod    2197   bash
  0   4080                    anon_zero:zfod    2207   vi
  0   4080                    anon_zero:zfod    2207   vi
...</programlisting>
    </example>

    <sect2 xml:id="gcggx">
      <title>Akcje zapisujące dane</title>

      <para><indexterm xml:id="indexterm-2">
          <primary>akcje zapisujące dane</primary>
        </indexterm> <indexterm xml:id="indexterm-3">
          <primary>actions</primary>

          <secondary>data recording</secondary>
        </indexterm>Akcje w tym podrozdziale domyślnie zapisują dane do
      głównego bufora, ale każdej akcji można nakazać zapis danych do
      spekulatywne (ang. speculative) buforów. Więcej informacji w <olink
      remap="external" targetdoc="chapter-4.xml" targetptr="gbxxu">Śledzenie
      spekulatywne</olink>.</para>

      <sect3 xml:id="gcggi">
        <title>Funkcja <function>trace </function></title>

        <programlisting>void trace(<replaceable>expression</replaceable>)</programlisting>

        <para><indexterm xml:id="indexterm-4">
            <primary>actions</primary>

            <secondary><literal>trace</literal></secondary>
          </indexterm>Najbardziej podstawową akcją jest
        <function>trace</function>, która przyjmuje jako argument wyrażenie D
        i zapisuje wynik działania do wskazanego bufora.</para>
      </sect3>

      <sect3 xml:id="gcgge">
        <title>Funkcja <function>tracemem</function></title>

        <programlisting>void tracemem(<replaceable>address</replaceable>, size_t <replaceable>nbytes</replaceable>)</programlisting>

        <para><indexterm xml:id="indexterm-5">
            <primary>actions</primary>

            <secondary><literal>tracemem</literal></secondary>
          </indexterm>Akcja <function>tracemem</function> kopiuje dane z
        adresu w pamięci do bufora. Ilość bajtów do skopiowania podane jest w
        argumencie <replaceable>nbytes</replaceable>. Adres pamięci spod
        którego należy skopiować dane podawany jest w argumencie
        <replaceable>addr</replaceable> jako wyrażenie D. Bufor, do którego
        należy skopiować dane podany jest w argumencie
        <replaceable>buf</replaceable>.</para>
      </sect3>

      <sect3 xml:id="gcgfz">
        <title>Funkcja <function>printf</function></title>

        <programlisting>void printf(string <replaceable>format</replaceable>, ...) </programlisting>

        <para><indexterm xml:id="indexterm-6">
            <primary>actions</primary>

            <secondary><literal>printf</literal></secondary>
          </indexterm>Podobnie do akcji <function>trace </function>
        <function>printf </function> śledzi wyrażenia D, pozwala jednak na
        sprecyzowanie formatu wyjścia w sposób podobny do <olink
        remap="external" targetdoc="816-5168" targetptr="printf-3c">
        <citerefentry>
            <refentrytitle>printf</refentrytitle>

            <manvolnum>3C</manvolnum>
          </citerefentry> </olink>. Podobnie jak w funkcji
        <literal>printf</literal> parametry składają się z łańcucha
        <replaceable>format</replaceable>, po którym następuje zmienna liczba
        argumentów. Domyślnie argumenty są kierowane do kierunkowego bufora.
        Argumenty są później formatowane do wydruku przez komendę
        <literal>dtrace</literal> według zdefiniowanego łańcucha
        formatu.</para>

        <para>Więcej informacji o akcji <function>printf </function> w <olink
        remap="external" targetdoc="817-6223" targetptr="chp-fmt">Chapter 12,
        <citetitle remap="chapter">Output Formatting,</citetitle> in
        <citetitle remap="book">Solaris Dynamic Tracing Guide</citetitle>
        </olink>.</para>
      </sect3>

      <sect3 xml:id="gcggy">
        <title>Funkcja <function>printa </function></title>

        <programlisting>void printa(<replaceable>agregacja</replaceable>)
void printa(string <replaceable>format</replaceable>, <replaceable>agregacja</replaceable>)</programlisting>

        <para><indexterm xml:id="indexterm-7">
            <primary>actions</primary>

            <secondary><literal>printa</literal></secondary>
          </indexterm>Akcja <function>printa </function>pozwala na drukowanie
        i formatowanie agregacji. Więcej informacji o agregacjach w <olink
        remap="external" targetdoc="817-6223" targetptr="chp-aggs">Chapter 9,
        <citetitle remap="chapter">Aggregations,</citetitle> w <citetitle
        remap="book">Solaris Dynamic Tracing Guide</citetitle> </olink>. Jeśli
        nie podano wartości <replaceable>format,
        </replaceable><function>printa</function> przekazuje polecenie
        konsumentowi DTrace. Konsument, któremu przekazano polecenie,
        przetwarza je i drukuje agregację w domyślnym formacie. Więcej
        informacji o łańcuchu formatu <function>printa</function> w <olink
        remap="external" targetdoc="817-6223" targetptr="chp-fmt">Chapter 12,
        <citetitle remap="chapter">Output Formatting,</citetitle> in
        <citetitle remap="book">Solaris Dynamic Tracing Guide</citetitle>
        </olink>.</para>
      </sect3>

      <sect3 xml:id="gcgfo">
        <title>Funkcja <function>stack</function></title>

        <programlisting>void stack(int <replaceable>nframes</replaceable>)
void stack(void)</programlisting>

        <para><indexterm xml:id="indexterm-8">
            <primary>actions</primary>

            <secondary><literal>stack</literal></secondary>
          </indexterm>Akcja <function>stack</function> zapisuje ślad stosu
        jądra do bufora kierunkowego. Wielkość stosu określana jest przez
        argument <replaceable>nframes</replaceable>. Jeśli nie podano
        <replaceable>nframes</replaceable>, akcja zapisuje liczbę ramek
        wynikającą z opcji <literal>stackframes</literal>.</para>
      </sect3>

      <sect3 xml:id="gcghb">
        <title>Funkcja <function>ustack</function></title>

        <programlisting>void ustack(int <replaceable>nframes</replaceable>, int <replaceable>strsize</replaceable>)
void ustack(int <replaceable>nframes</replaceable>)
void ustack(void)</programlisting>

        <para><indexterm xml:id="indexterm-9">
            <primary>actions</primary>

            <secondary><literal>ustack</literal></secondary>
          </indexterm>Akcja <function>ustack</function> zapisuje stos
        użytkownika do bufora kierunkowego. Wielkość stosu użytkownika jest
        równa wartości podanej w <replaceable>nframes</replaceable>. Jeśli nie
        podano wartości dla <replaceable>nframes</replaceable>, akcja
        <literal>ustack</literal> zapisuje liczbę ramek stosu podaną w opcji
        <literal>ustackframes</literal>. Akcja <function>ustack
        </function>ustala adres wywołujących ją ramek przy odpaleniu sondy.
        Akcja <function>ustack </function>nie tłumaczy ramek stosu na symbole
        aż do momentu przetworzenia akcji przez konsumenta DTrace na poziomie
        użytkownika. Jeśli podano wartość <replaceable>strsize</replaceable> i
        jest ona niezerowa, akcja alokuje podaną ilość przestrzeni na łańcuch
        znaków i używa jej do bezpośredniego tłumaczenia adres-symbol w
        jądrze.</para>
      </sect3>

      <sect3 xml:id="gcgfq">
        <title>Funkcja <function>jstack</function></title>

        <programlisting>void jstack(int <replaceable>nframes</replaceable>, int <replaceable>strsize</replaceable>)
void jstack(int <replaceable>nframes</replaceable>)
void jstack(void)</programlisting>

        <para><indexterm xml:id="indexterm-10">
            <primary>actions</primary>

            <secondary><literal>jstack</literal></secondary>
          </indexterm>Akcja <function>jstack </function>jest dowiązaniem do
        akcji <function>ustack</function> używającym wartości podanej w opcji
        <literal>jstackframes</literal> do określenia ilości ramek. Akcja
        <literal>jstack</literal> używa wartości podanej w opcji
        <literal>jstackstrsize</literal> do określenia wielkości łańcucha
        znakowego. Akcja <literal>jstacksize</literal> jest domyślnie
        niezerowa.</para>
      </sect3>
    </sect2>

    <sect2 xml:id="gcfsm">
      <title>Akcje niszczycielskie (ang. destructive actions) </title>

      <para><indexterm xml:id="indexterm-11">
          <primary>destructive actions</primary>
        </indexterm> <indexterm xml:id="indexterm-12">
          <primary>actions</primary>

          <secondary>destructive</secondary>
        </indexterm>W celu używania akcji niszczycielskich, trzeba na nie
      samodzielnie zezwolić. Można to zrobić używając opcji
      <option>w</option>. Przy próbie użycia niszczycielskiej akcji bez
      zezwolenia na nie, <command>dtrace</command> nie wykona akcji i
      wydrukuje komunikat podobny do poniższego:</para>

      <programlisting>dtrace: failed to enable 'syscall': destructive actions not allowed</programlisting>

      <para>Więcej informacji o akcjach DTrace, włącznie z niszczycielskimi, w
      <olink remap="external" targetdoc="817-6223"
      targetptr="chp-actsub">Chapter 10, <citetitle remap="chapter">Actions
      and Subroutines,</citetitle> in <citetitle remap="book">Solaris Dynamic
      Tracing Guide</citetitle> </olink>.</para>

      <sect3 xml:id="gcfrv">
        <title>Akcje niszczycielskie w stosunku do niektórych procesów (ang.
        process destructive actions)</title>

        <para><indexterm xml:id="indexterm-13">
            <primary>destructive actions</primary>

            <secondary>process</secondary>
          </indexterm>Niektóre akcje są niszczycielskie tylko w przypadku
        pewnych procesów. Akcje te są dostępne użytkownikom o przywilejach
        <literal>dtrace_proc</literal> i <literal>dtrace_user</literal>.
        Więcej o przywilejach DTrace w <olink remap="external"
        targetdoc="817-6223" targetptr="chp-sec">Chapter 35, <citetitle
        remap="chapter">Security,</citetitle> in <citetitle
        remap="book">Solaris Dynamic Tracing Guide</citetitle>
        </olink>.</para>

        <sect4 xml:id="gcfrz">
          <title>Funkcja <function>stop</function></title>

          <para><indexterm xml:id="indexterm-14">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>stop</literal></tertiary>
            </indexterm>Kiedy odpalona zostaje sonda przy włączonej akcji
          <function>stop</function>, proces odpalający sondę zatrzymuje się po
          opuszczeniu jądra. Proces zatrzymuje się w sposób identyczny do
          akcji <olink remap="external" targetdoc="816-5174"
          targetptr="proc-4"> <citerefentry>
              <refentrytitle>proc</refentrytitle>

              <manvolnum>4</manvolnum>
            </citerefentry> </olink>.</para>
        </sect4>

        <sect4 xml:id="gcfqz">
          <title>Funkcja <function>raise</function></title>

          <programlisting>void raise(int <replaceable>signal</replaceable>)</programlisting>

          <para><indexterm xml:id="indexterm-15">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>raise</literal></tertiary>
            </indexterm>Akcja <function>raise </function>wysyła określony
          sygnał do wykonywanego właśnie procesu.</para>
        </sect4>

        <sect4 xml:id="gcfsd">
          <title>Funkcja <function>copyout</function></title>

          <programlisting>void copyout(void *<replaceable>buf</replaceable>, uintptr_t <replaceable>addr</replaceable>, size_t <replaceable>nbytes</replaceable>)</programlisting>

          <para><indexterm xml:id="indexterm-16">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>copyout</literal></tertiary>
            </indexterm>Akcja <function>copyout </function> kopiuje dane z
          bufora do podanego adresu w pamięci. Ilość kopiowanych bajtów
          określana jest przez <replaceable>nbytes</replaceable>. Bufor
          źródłowy wskazywany jest przez <replaceable>buf</replaceable>. Adres
          docelowy wskazywany jest przez <replaceable>addr</replaceable>.
          Adres ten należy do przestrzeni adresów procesu związanego z
          aktualnym wątkiem.</para>
        </sect4>

        <sect4 xml:id="gcfrq">
          <title>Funkcja <function>copyoutstr</function></title>

          <programlisting>void copyoutstr(string <replaceable>str</replaceable>, uintptr_t <replaceable>addr</replaceable>, size_t <replaceable>maxlen</replaceable>)</programlisting>

          <para><indexterm xml:id="indexterm-17">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>copyoutstr</literal></tertiary>
            </indexterm>Akcja <function>copyoutstr </function>kopiuje łańcuch
          wskazany przez <replaceable>str</replaceable> do pamięci o wskazanym
          adresie. adresu w pamięci. Docelowy adres wskazywany jest przez
          <replaceable>addr</replaceable>. Adres ten należy do przestrzeni
          adresów procesu związanego z aktualnym wątkiem.</para>
        </sect4>

        <sect4 xml:id="gcfsj">
          <title>Funkcja <function>system</function></title>

          <programlisting>void system(string <replaceable>program</replaceable>, ...) </programlisting>

          <para><indexterm xml:id="indexterm-18">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>system</literal></tertiary>
            </indexterm>Akcja <function>system </function>powoduje wykonanie
          programu wskazanego przez <replaceable>program</replaceable>, jakby
          był podany na wejściu powłoce.</para>
        </sect4>
      </sect3>

      <sect3 xml:id="gcfre">
        <title>Akcje niszczycielskie w odniesieniu do jądra (ang. kernel
        destructive actions)</title>

        <para><indexterm xml:id="indexterm-19">
            <primary>destructive actions</primary>

            <secondary>kernel</secondary>
          </indexterm>Niektóre akcje niszczycielskie mogą mieć wpływ na cały
        system. Należy używać ich ze szczególną ostrożnością. Mają wpływ na
        wszystkie procesy w systemie i mogą mieć wpływ na inne systemy,
        zależnie od usług sieciowych oferowanych przez system.</para>

        <sect4 xml:id="gcfra">
          <title>Funkcja <function>breakpoint</function></title>

          <programlisting>void breakpoint(void)</programlisting>

          <para><indexterm xml:id="indexterm-20">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>breakpoint</literal></tertiary>
            </indexterm>Akcja <function>breakpoint</function> uruchamia punk
          zatrzymania (ang. breakpoint) jądra, powodując zatrzymanie wykonania
          jądra i przekazanie kontroli debuggerowi jądra. Debugger jądra
          wydrukuje wskazanie sondy DTrace, która uruchomiła akcję.</para>
        </sect4>

        <sect4 xml:id="gcfru">
          <title>Funkcja <function>panic</function></title>

          <programlisting>void panic(void)</programlisting>

          <para><indexterm xml:id="indexterm-21">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>panic</literal></tertiary>
            </indexterm>Po uruchomieniu przez sondę akcji <function>panic
          </function>jądro panikuje. Można w ten sposób wymusić zrzut obrazu
          jądra (ang. kernel crash dump) w konkretnym momencie. Można jej
          używać z połączeniu z buforowaniem pierścieniowym (ang. ring
          buffering) i analizą pośmiertną (ang. post mortem analysis) do
          diagnozowania problemów z systemem. Więcej informacji w <olink
          remap="external" targetdoc="817-6223" targetptr="chp-buf">Chapter
          11, <citetitle remap="chapter">Buffers and Buffering,</citetitle> in
          <citetitle remap="book">Solaris Dynamic Tracing Guide</citetitle>
          </olink> i <olink remap="external" targetdoc="817-6223"
          targetptr="chp-post">Chapter 37, <citetitle
          remap="chapter">Post mortem Tracing,</citetitle> in <citetitle
          remap="book">Solaris Dynamic Tracing Guide</citetitle>
          </olink>.</para>
        </sect4>

        <sect4 xml:id="gcfsp">
          <title>Funkcja <function>chill</function></title>

          <programlisting>void chill(int <replaceable>nanoseconds</replaceable>)</programlisting>

          <para><indexterm xml:id="indexterm-22">
              <primary>actions</primary>

              <secondary>destructive</secondary>

              <tertiary><literal>chill</literal></tertiary>
            </indexterm>Po uruchomieniu akcji <function>chill</function>
          DTrace wykonuje pętlę przez podaną liczbę nanosekund. Akcja ta jest
          przydatna przy analizowaniu problemów związanych z czasem. W
          kontekście sond DTrace wyłączone są przerwania, stąd dowolne użycie
          akcji<function> chill</function> spowoduje opóźnienia przerwań,
          planisty i egzekutora (ang. dispatch).</para>
        </sect4>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="gcggh">
    <title>Agregacje DTrace</title>

    <para>Przy analizowaniu zagadnień związanych z wydajnością dane
    zagregowane są częściej bardziej przydatne od pojedynczych danych. DTrace
    ma kilka wbudowanych funkcji agregujących. Jeśli funkcja agregująca
    zastosowana jest do podzbiorów danych a później znów zastosowana do
    wyników analizy tych podzbiorów, wynik jest identyczny, jak przy
    zastosowaniu funkcji do całego zbioru danych. </para>

    <para>DTrace przechowuje aktualny licznik danych do agregacji. Funkcje
    agregacyjne przechowują wyłącznie aktualny wynik i nowy element, do
    którego stosuje się funkcję. Aktualne pośrednie wyniki przechowywane są
    odnośnie każdego procesora. Taki schemat alokacji nie wymaga blokad, jest
    więc bardzo skalowalny. </para>

    <sect2 xml:id="gcggc">
      <title>Składna agregacji DTrace</title>

      <para>Agregacja DTrace ma następującą postać uogólnioną:</para>

      <programlisting>@name[ <replaceable>keys</replaceable> ] = aggfunc( <replaceable>args</replaceable> );</programlisting>

      <para>W tej postaci zmienne definiowane są jak poniżej:</para>

      <variablelist>
        <varlistentry>
          <term><literal>name</literal></term>

          <listitem>
            <para>Nazwa agregacji poprzedzona znakiem
            <literal>@</literal>.</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><literal>keys</literal></term>

          <listitem>
            <para>Oddzielona przecinkami lista wyrażeń języka skryptowego
            D.</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><literal>aggfunc</literal></term>

          <listitem>
            <para>Jedna z funkcji agregacyjnych DTrace.</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><literal>args</literal></term>

          <listitem>
            <para>Oddzielona przecinkami lista argumentów właściwych dla
            funkcji agregacyjnej.</para>
          </listitem>
        </varlistentry>
      </variablelist>

      <table frame="topbot" xml:id="gcggr">
        <title>DTrace Aggregating Functions</title>

        <tgroup cols="3" colsep="0" rowsep="0">
          <colspec colwidth="20.45*" />

          <colspec colwidth="20.45*" />

          <colspec colwidth="58.10*" />

          <thead>
            <row rowsep="1">
              <entry><para>Nazwa funkcji</para></entry>

              <entry><para>Argumenty</para></entry>

              <entry><para>Wynik</para></entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><para> <literal>count</literal> </para></entry>

              <entry><para>brak</para></entry>

              <entry><para>Ilość razy wywołania funkcji
              <literal>count</literal>.</para></entry>
            </row>

            <row>
              <entry><para> <literal>sum</literal> </para></entry>

              <entry><para>wyrażenie skalarne</para></entry>

              <entry><para>Całkowita wartość podanych wyrażeń.</para></entry>
            </row>

            <row>
              <entry><para> <literal>avg</literal> </para></entry>

              <entry><para>wyrażenie skalarne</para></entry>

              <entry><para>Arytmetyczna średnia z podanych
              wyrażeń.</para></entry>
            </row>

            <row>
              <entry><para> <literal>min</literal> </para></entry>

              <entry><para>wyrażenie skalarne</para></entry>

              <entry><para>Minimum z podanych wyrażeń.</para></entry>
            </row>

            <row>
              <entry><para> <literal>max</literal> </para></entry>

              <entry><para>wyrażenie skalarne</para></entry>

              <entry><para>Maksimum z podanych wyrażeń.</para></entry>
            </row>

            <row>
              <entry><para> <literal>lquantize</literal> </para></entry>

              <entry><para>wyrażenie skalarne, ograniczenie dolne,
              ograniczenie górne, krok</para></entry>

              <entry><para>Liniowy rozkład gęstości z wartości podanych
              wyrażeń przedziale wyznaczonym przez podane ograniczenia dolne i
              górne. Funkcja ta zwiększa wartość <emphasis>najwyższego
              </emphasis> wiadra, które ma wartość
              <emphasis>niższą</emphasis>, niż podane
              wyrażenie.</para></entry>
            </row>

            <row>
              <entry><para> <literal>quantize</literal> </para></entry>

              <entry><para>wyrażenie skalarne</para></entry>

              <entry><para>Kwadratowy rozkład gęstości wartości z podanych
              wyrażeń. Funkcja zwiększa wartość w
              <emphasis>najwyższym</emphasis> kwadracie wiadra, które ma
              wartość <emphasis>niższą</emphasis>, niż podane
              wyrażenie.</para></entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <example xml:id="gcgfw">
        <title>Using an Aggregating Function</title>

        <para>W poniższym przykładzie funkcja agregacyjna
        <command>count</command> została użyta do zliczenia ilości wykonania
        wywołania systemowego <olink remap="external" targetdoc="816-5167"
        targetptr="write-2"> <citerefentry>
            <refentrytitle>write</refentrytitle>

            <manvolnum>2</manvolnum>
          </citerefentry> </olink> dla każdego procesu. Agregacja nie drukuje
        żadnych danych do momentu przerwania wykonywania komendy
        <command>dtrace</command>. Dane wyjściowe przedstawiane są jako suma
        danych zebranych podczas działania komendy
        <command>dtrace</command>.</para>

        <screen># <userinput>cat writes.d</userinput>
#!/usr/sbin/dtrace -s
syscall::write:entry]
{   @numWrites[execname] = count();
}

# <userinput>./writes.d</userinput>
dtrace: script 'writes.d' matched 1 probe
<userinput>^C</userinput>
  dtrace                           1
  date                             1
  bash                             3
  grep                            20
  file                           197
  ls                             201</screen>
      </example>
    </sect2>
  </sect1>
</chapter>
